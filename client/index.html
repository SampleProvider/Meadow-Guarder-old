<html>
<head>
	<meta charset="utf-8">
	<!--<meta name="viewport" content="width=device-width">-->
	<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport"/>

	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
	<meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src http://bajie:3000 http://localhost:3000 http://guarded-meadow-00030.herokuapp.com 'unsafe-eval' 'unsafe-inline' https://cdn.socket.io/socket.io-1.4.5.js; style-src 'self' 'unsafe-inline'; child-src 'none'; object-src 'none'">
	<title>Meadow Guarders</title>
	<link href="client/style.css" rel="stylesheet" type="text/css">
</head>
<body>
	<div id="sign" style="display:inline-block;">
		<button id = "signIn" class="UI-button-light">Sign In</button>
		<label id="username-label" class="UI-text-light" for="username">Username:</label><br><br>
		<label id="password-label" class="UI-text-light" for="password">Password:</label>
		<form><input class="UI-input-light" type="text" id="username" name="username" autocomplete="off"><input class="UI-input-light" type="password" id="password" name="password" autocomplete="off"></form><br><br>
		<button id ="createAccount" class="UI-button-light">Create Account</button>
		<button id ="deleteAccount" class="UI-button-light">Delete Account</button>
		<div id="signError"></div>
		<div class="UI-text-light" style="top: 180px;left: 5px;font-size: 35px;">HOW TO PLAY: There are monsters that will shoot ninja stars at you. You can click to shoot bullets, right click to use a special attack, and spacebar to heal yourself. Each attack has a cooldown. There are certain NPC's that can send you on a quest, and you get XP as a reward.<br><br>Disclaimer: The server only processes maps with players in them. For more information, click <a href="https://github.com/maitian352/Meadow-Guarder/issues/89">here</a>.</div>
		<div class="UI-text-light" style="bottom: 5px;right: 5px;font-size: 5px;">Disclaimer: We do not take responsibility for your house being blown up by a nuke.</div>
	</div>
	<div id="gameDiv" style="display:none;">
		<canvas id="ctx"></canvas>
		<div id="blackShade" onmousedown="mouseDown(event)" onmouseup="mouseUp(event)"></div>
		<div id="mapName" class="UI-text-light" onmousedown="mouseDown(event)" onmouseup="mouseUp(event)">Starter House</div>
		<div id="mainAttack" class="UI-text-light"></div>
		<div id="secondaryAttack" class="UI-text-light"></div>
		<div id="heal" class="UI-text-light"></div>
		<div id="questInventoryDiv" class="UI-text-light" onmouseover="mouseUp(event)"></div>
		<div id="fps" class="UI-text-light"></div>
		<div id="chat-text" class="UI-text-light" onmousedown="mouseDown(event)" onmouseup="mouseUp(event)">
			<div>Welcome to Meadow Guarders Open 0.1.0!</div>
		</div>

		<form id="chat-form" autocomplete="off" onmouseover="mouseUp(event)">
			<input id="chat-input" class="UI-input-light" type="text"></input>
		</form>
		<div id="window" class="window" onmouseover="mouseUp(event)">
			<div class="window-bar">
				<div>Window Title</div>
				<span class="window-close">
					<svg viewport="0 0 12 12" version="1.1" width="18" height="18" xmlns="http://www.w3.org/2000/svg">
						<line x1="2" y1="12"
							x2="12" y2="2"
							stroke="black"
							strokeWidth="5"/>
						<line x1="2" y1="2"
							x2="12" y2="12"
							stroke="black"
							strokeWidth="5"/>
					</svg>
				</span>
			</div>
			<div class="window-body">
				Window body
			</div>
			<div id="windowMain">

				<div id="inventory">
					<div id="inventoryPlayer" class="UI-text-light">
						<div id="inventoryPlayerName"></div>
						<canvas id="inventoryPlayerDisplay"></canvas>
					</div>
					<div id="currentEquip"></div>
					<div id="inventoryItem"></div>
				</div>
				<div id="debugScreen" style="display: none;">
					<div id="debug-text" class="UI-text-light">
						<div>Debug info will show up here.</div>
					</div>

					<form id="debug-form" autocomplete="off">
						<input id="debug-input" class="UI-input-light" type="text"></input>
					</form>
				</div>
				<div id="statScreen" style="display: none;">
					<div id="stat-text" class="UI-text-light">
						<div id="stat-attack">Attack Power:</div>
						<div id="stat-defense">Defense Power:</div>
					</div>

				</div>
				<div id="questScreen" style="display: none;">
					<div id="questName">Weird House</div>
					<div id="questDescription">Invenstigate a weird house in the map Forest. Go on a big boss battle against the Monster Boss.</div>
					<button id="questStart" onclick="startQuest()">Start Quest</button>
				</div>
				<div id="worldMap" style="display: none;">
					<canvas id="worldMapCanvas" onmousedown="mapMouseDown(event)" onmouseup="mapMouseUp(event)"></canvas>
					<canvas id="worldMapEntityCanvas" onmousedown="mapMouseDown(event)" onmouseup="mapMouseUp(event)"></canvas>
				</div>
			</div>
			
			<div id="menu-text" class="UI-text-light">
				<button id="inventoryButton" class="UI-button-light menuButton">Inventory</button>
				<button id="debugButton" class="UI-button-light menuButton">Debug</button>
				<button id="statButton" class="UI-button-light menuButton">Stats</button>
				<button id="worldMapButton" class="UI-button-light menuButton">World Map</button>
				<button class="UI-button-light menuButton">Useless</button>
				<button class="UI-button-light menuButton">Useless</button>
				<button class="UI-button-light menuButton">Useless</button>
				<button class="UI-button-light menuButton">Useless</button>
				<button class="UI-button-light menuButton">Useless</button>
				<button class="UI-button-light menuButton">Useless</button>
				<button class="UI-button-light menuButton">Useless</button>
				<button class="UI-button-light menuButton">Useless</button>
				<button class="UI-button-light menuButton">Useless</button>
				<button class="UI-button-light menuButton">Useless</button>
				<button class="UI-button-light menuButton">Useless</button>
				<button class="UI-button-light menuButton">Useless</button>
			</div>
		</div>
		<div id="selfDisplay" onmouseover="mouseUp(event)">
			<div id="healthBar">
				<div id="healthBarValue"></div>
				<div id="healthBarText"></div>
			</div>
			<div id="xpBar">
				<div id="xpBarValue"></div>
				<div id="xpBarText"></div>
			</div>
			<div id="magicBar">
				<div id="magicBarValue"></div>
				<div id="magicBarText"></div>
			</div>
		</div>
		<div id="menu" onmouseover="mouseUp(event)">
			<button id="menuDropdown" class="UI-button-light" onclick="useMenuDropdown()">Menu &#x25BC;</button>
			<div id="menuDropdownItem" class="UI-dropdown-light">
				<button id="windowtoggle" class="UI-button-light">Inventory</button>
				<button id="signOut" class="UI-button-light" onclick="history.go(0)">Log Out</button>
			</div>
		</div>
		
		<div id="interactMenu" class="UI-display-light" style="display:none;" onmousedown="mouseDown(event)" onmouseup="mouseUp(event)">
			<div id="interactMenuText" class="UI-text-light">Hey and tianmu is a poop</div>
			<button id="interactMenuButton1" class="interactMenuButton UI-button-light" onclick="response(1)">Wait really?</button>
			<button id="interactMenuButton2" class="interactMenuButton UI-button-light" onclick="response(2)">Gotcha.</button>
			<button id="interactMenuButton3" class="interactMenuButton UI-button-light" onclick="response(3)">HAHAHAHA!</button>
			<button id="interactMenuButton4" class="interactMenuButton UI-button-light" onclick="response(4)">NO IM NOT!</button>
		</div>

	</div>
	<div id="spectator" style="display:none;" onmouseover="mouseUp(event)">
		<div class="death-screen"></div>
		<button class="spectator">You're a spectator!</button>
		<button class="respawn" onclick="respawn()">Respawn</button>
	</div>
	<div id="ads" style="display:none" onmouseover="mouseUp(event)">
		<button id="ad1" class="UI-button-light" onclick="disconnect()">Get FREE PlastiSnow!</button>
		<button id="ad2" class="UI-button-light" onclick="disconnect()">Do YOU want YOUR ad featured here? Then click <a href="https://forms.gle/stnavsadkja7r7b96">THIS LINK</a> to write a application!</button>
		<button id="ad3" class="UI-button-light" onclick="history.go(0)">Go to <a href="https://docs.google.com/forms/d/e/1FAIpQLSfyp_-6rxw0Kh-e4dru1Lpb6VRwoN2f_L_rawko3Hbm6n9KvQ/viewform">Tianmu's Lego center</a>! Get a free discount if your the first 100 People to get there!</button>
	</div>
	<div id="disconnected" style="display:none;" onmouseover="mouseUp(event)">
		<button class="disconnected">Disconnected</button>
	</div>
	<!--<script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>-->
	<link href="/client/websiteAssets/MiniSet2.ttf@14d552ae72d147f7b96abae4220f32c0.woff" rel="stylesheet">

	<script src="https://cdn.socket.io/socket.io-1.4.5.js"></script>

	<!--<script src="/client/socket.js"></script>-->

	<script src="/client/Inventory.js"></script>
	<script src="/client/instrument.js"></script>
	<!--<script src="/socket.io/socket.io.js"></script>-->

	<script nonce="EDNnf03nceIOfn39fn3e9h3sdfa">
		var WIDTH = window.innerWidth;
		var HEIGHT = window.innerHeight;

		var cameraX = 0;
		var cameraY = 0;
		var lastCameraX = 0;
		var lastCameraY = 0;
		var mouseCameraX = 0;
		var mouseCameraY = 0;

		var menu = 'none';

		var RENDERDIST = 5;
		var STATE = 'signIn';
		var VERSION = '0.1.0';

		var DEBUG = 0;
		
		var socket = io({
			reconnection:false,
		});
		socket.on('connect_error',function(){
			setTimeout(function(){
				socket.connect();
			},1000);
		});
		socket.on('disconnect',function(){
			setTimeout(function(){
				socket.connect();
			},1000);
		});

		var gameDiv = document.getElementById('gameDiv');
		var mainAttackDiv = document.getElementById('mainAttack');
		var secondaryAttackDiv = document.getElementById('secondaryAttack');
		var healDiv = document.getElementById('heal');
		var disconnectedDiv = document.getElementById('disconnected');
		var spectatorDiv = document.getElementById('spectator');
		var adDiv = document.getElementById('ads');
		var ctxRaw = document.getElementById('ctx');
		var inventoryPlayerDisplayRaw = document.getElementById('inventoryPlayerDisplay');
		var signDiv = document.getElementById('sign');
		var worldMapButton = document.getElementById('worldMapButton');
		var worldMapDiv = document.getElementById('worldMapDiv');
		var blackShade = document.getElementById('blackShade');
		var healthBarText = document.getElementById('healthBarText');
		var healthBarValue = document.getElementById('healthBarValue');
		var xpBarText = document.getElementById('xpBarText');
		var xpBarValue = document.getElementById('xpBarValue');
		var interactMenu = document.getElementById('interactMenu');
		var signDivUsername = document.getElementById('username');
		var signDivPassword = document.getElementById('password');
		var signDivSignIn = document.getElementById('signIn');
		var signDivCreateAccount = document.getElementById('createAccount');
		var signDivDeleteAccount = document.getElementById('deleteAccount');
		
		var canSignIn = true;
		signDivSignIn.onclick = function(){
			if(canSignIn){
				socket.emit('signIn',{username:signDivUsername.value,password:signDivPassword.value});
				canSignIn = false;
				setTimeout(() => {
					canSignIn = true;
				},2000);
			}
		}
		signDivCreateAccount.onclick = function(){
			socket.emit('createAccount',{username:signDivUsername.value,password:signDivPassword.value});
		}
		signDivDeleteAccount.onclick = function(){
			socket.emit('deleteAccount',{username:signDivUsername.value});
		}
		socket.on('signInResponse',function(data){
			if(data.success === 3){
				document.getElementById('inventoryPlayerName').innerHTML = data.username;
				STATE = 'game';
			}
			else if(data.success === 2){
				alert("The account with username \'" + signDivUsername.value + "\' and password \'" + signDivPassword.value + "\' is already used. The other account will be disconnected shortly. Please try to sign again.");
			}
			else if(data.success === 1){
				alert("Incorrect Password.");
			}
			else{
				alert("No account found with username \'" + signDivUsername.value + "\' and password \'" + signDivPassword.value + "\'.");
			}
		});
		socket.on('createAccountResponse',function(data){
			if(data.success == 1){
				alert("Account created with username \'" + signDivUsername.value + "\' and password \'" + signDivPassword.value + "\'.");
			}
			else if(data.success == 0){
				alert("Sorry, there is already an account with username \'" + signDivUsername.value + "\'.");
			}
			else if(data.success == 2){
				alert("Please use a username with 3+ characters.");
			}
			else if(data.success == 3){
				alert("Invalid characters.");
			}
			else if(data.success == 4){
				alert("Please use a shorter username / password.");
			}
		});
		socket.on('deleteAccountResponse',function(data){
			if(data.success == 1){
				alert("Deleted account created with username \'" + signDivUsername.value + "\'.");
			}
			else if(data.success == 0){
				alert("Sorry, there is no account with username \'" + signDivUsername.value + "\'.");
			}
		});
		
		var chatText = document.getElementById('chat-text');
		var chatInput = document.getElementById('chat-input');
		var chatForm = document.getElementById('chat-form');
		var debugText = document.getElementById('debug-text');
		var debugInput = document.getElementById('debug-input');
		var debugForm = document.getElementById('debug-form');
		var chat = '<div>Welcome to Meadow Guarders Open ' + VERSION + '!</div>';
		var debug = '<div>Debug info will show up here.</div>'
		var chatPress = false;
		var inChat = false;

		socket.on('addToChat',function(data){
			if(!selfId && !data.logOnMessage){
				return;
			}
			var scroll = false;
			if(chatText.scrollTop + chatText.clientHeight >= chatText.scrollHeight - 5){
				scroll = true;
			}
			var d = new Date();
			var m = '' + d.getMinutes();
			if(m.length === 1){
				m = '' + 0 + m;
			}
			if(m === '0'){
				m = '00';
			}
			chat += '<div class="textNone"' + data.style + "[" + d.getHours() + ":" + m + "] " + data.message + '</div>';
			chatText.innerHTML = chat + '<br>';
			if(scroll){
				chatText.scrollTop = chatText.scrollHeight;
			}
		});
		chatForm.onsubmit = function(e){
			e.preventDefault();
			socket.emit('sendMsgToServer',chatInput.value);
			chatInput.value = '';
		}
		socket.on('addToDebug',function(data){
			var scroll = false;
			if(debugText.scrollTop + debugText.clientHeight >= debugText.scrollHeight - 5){
				scroll = true;
			}
			debug += '<div class="text"' + data + '</div>';
			debugText.innerHTML = debug + '<br>';
			if(scroll){
				debugText.scrollTop = debugText.scrollHeight;
			}
		});
		debugForm.onsubmit = function(e){
			e.preventDefault();
			socket.emit('sendDebugToServer',debugInput.value);
			debugInput.value = '';
		}
		chatInput.onkeydown = function(e){
			chatPress = true;
		}
		chatInput.onmousedown = function(e){
			inChat = true;
		}
		debugInput.onkeydown = function(e){
			chatPress = true;
		}
		debugInput.onmousedown = function(e){
			inChat = true;
		}

		var disconnect = function(){
			socket.emit("timeout");
		}
		var ctx = document.getElementById("ctx").getContext("2d");
		var inventoryPlayerDisplay = document.getElementById("inventoryPlayerDisplay").getContext("2d");
		var worldMap = document.getElementById("worldMapCanvas").getContext("2d");
		var worldMapEntity = document.getElementById("worldMapEntityCanvas").getContext("2d");
		ctx.canvas.width = window.innerWidth;
		ctx.canvas.height = window.innerHeight;
		ctx.canvas.width = 1536;
		ctx.canvas.height = 722;
		ctx.imageSmoothingEnabled = false;
		worldMap.imageSmoothingEnabled = false;
		//ctx.setTransform(1, 0, 0, 1, 120, 0);
		worldMap.canvas.width = 910;
		worldMap.canvas.height = 730;
		worldMapEntity.canvas.width = 910;
		worldMapEntity.canvas.height = 730;
		ctx.filter = 'url(#remove-alpha)';
		worldMap.filter = 'url(#remove-alpha)';
		worldMapEntity.filter = 'url(#remove-alpha)';
		inventoryPlayerDisplay.canvas.width = 96;
		inventoryPlayerDisplay.canvas.height = 152;

		var maps = {};

		var tileset = new Image();
		tileset.src = '/client/maps/roguelikeSheet.png';
		var tilesetLoaded = false;
		tileset.onload = function(){
			tilesetLoaded = true;
		};
		var loadedMap = {};
		var renderLayers = function(json,name){
			var tempLower = new OffscreenCanvas(json.layers[0].width * 64,json.layers[0].height * 64);
			var tempUpper = new OffscreenCanvas(json.layers[0].width * 64,json.layers[0].height * 64);
			var glLower = tempLower.getContext('2d');
			var glUpper = tempUpper.getContext('2d');
			
			//glLower.setTransform(1, 0, 0, 1, 120, 0);
			glLower.filter = 'url(#remove-alpha)';
			//glUpper.setTransform(1, 0, 0, 1, 120, 0);
			glUpper.filter = 'url(#remove-alpha)';
			glLower.imageSmoothingEnabled = false;
			glUpper.imageSmoothingEnabled = false;
			for(var i = 0;i < json.layers.length;i++){
				if(json.layers[i].type === "tilelayer" && json.layers[i].visible){
					var size = json.tilewidth;
					for(var j = 0;j < json.layers[i].data.length;j++){
						tile_idx = json.layers[i].data[j];
						if(tile_idx !== 0){
							var img_x, img_y, s_x, s_y;
							var tile = json.tilesets[0];
							tile_idx -= 1;
							img_x = (tile_idx % ((tile.imagewidth + tile.spacing) / (size + tile.spacing))) * (size + tile.spacing);
							img_y = ~~(tile_idx / ((tile.imagewidth + tile.spacing) / (size + tile.spacing))) * (size + tile.spacing);
							s_x = (j % json.layers[i].width) * size;
							s_y = ~~(j / json.layers[i].width) * size;
							if(json.layers[i].name === 'Above0' || json.layers[i].name === 'Above1'){
								glUpper.drawImage(tileset,Math.round(img_x),Math.round(img_y),size,size,Math.round(s_x),Math.round(s_y),size,size);
							}
							else{
								glLower.drawImage(tileset,Math.round(img_x),Math.round(img_y),size,size,Math.round(s_x),Math.round(s_y),size,size);
							}
						}
					}
				}
			}
			loadedMap[name] = {
				lower:tempLower,
				upper:tempUpper,
			}
		}
		var loadTileset = function(json,name){
			if(tilesetLoaded){
				renderLayers(json,name);
			}
			else{
				setTimeout(function(){
					loadTileset(json,name);
				},10);
			}
		}
		var loadMap = function(name){
			var request = new XMLHttpRequest();
			request.open('GET',"/client/maps/" + name + ".json",true);

			request.onload = function(){
				if(this.status >= 200 && this.status < 400){
					// Success!
					var json = JSON.parse(this.response);
					maps[name] = json.backgroundcolor;
					loadTileset(json,name);
				}
				else{
					// We reached our target server, but it returned an error
				}
			};

			request.onerror = function(){
				// There was a connection error of some sort
			};

			request.send();
		}
		const times = [];
		let fps;

		var documentHidden = false;

		function refreshLoop(){
			window.requestAnimationFrame(() => {
				const now = performance.now();
				while(times.length > 0 && times[0] <= now - 1000){
					times.shift();
				}
				times.push(now);
				fps = times.length;
				document.getElementById('fps').innerHTML = "FPS: " + fps;
				refreshLoop();
			});
		}

		refreshLoop();

		var shadeSpeed = -0.01;
		var shadeAmount = 1;
		var mapShadeSpeed = 0;
		var mapShadeAmount = 0;
		var Img = {};
		Img.player = new Image();
		Img.player.src = '/client/img/Player Map Bright.png';
		Img.playerDisplay = new Image();
		Img.playerDisplay.src = '/client/img/Untitled.png';
		Img.monster = new Image();
		Img.monster.src = '/client/img/Pet.png';
		Img.monsterGreen = new Image();
		Img.monsterGreen.src = '/client/img/Monster Green.png';
		Img.monsterBlue = new Image();
		Img.monsterBlue.src = '/client/img/Monster Blue.png';
		Img.monsterOrange = new Image();
		Img.monsterOrange.src = '/client/img/Monster Orange.png';
		Img.monsterWhite = new Image();
		Img.monsterWhite.src = '/client/img/Monster White.png';
		Img.monsterBlack = new Image();
		Img.monsterBlack.src = '/client/img/Monster Black.png';
		Img.monsterBoss = new Image();
		Img.monsterBoss.src = '/client/img/Monster Boss.png';
		Img.npc = new Image();
		Img.npc.src = '/client/img/Player Map Npc 2.png';
		Img.bullet = new Image();
		Img.bullet.src = '/client/img/Bullet.png';
		Img.healthBar = new Image();
		Img.healthBar.src = '/client/img/Health0.png';
		Img.healthBarEnemy = new Image();
		Img.healthBarEnemy.src = '/client/img/HealthEnemy.png';
		Img.Village = new Image();
		Img.Village.src = '/client/img/Village.png';
		Img.River = new Image();
		Img.River.src = '/client/img/River.png';
		Img.playericon = new Image();
		Img.playericon.src = '/client/img/playericon.png';
		ctx.webkitImageSmoothingEnabled = false;
		var mouseX = 0;
		var mouseY = 0;
		var mapMouseX = mouseX + WIDTH / 2;
		var mapMouseY = mouseY + HEIGHT / 2;
		var mapDragX = mouseX + WIDTH / 2;
		var mapDragY = mouseY + HEIGHT / 2;
		var mapX = -9600;
		var mapY = -6400;
		var mapDrag = true;
		var mapRatio = 1000;
		var mapLocations = [
			['','Lower Deadlands','',''],
			['','The Outskirts','Forest',''],
			['The Bridge','River','Village','The Pathway'],
			['Lilypad Kingdom','Lilypad Path Part 1','Upper Mine Deposit',''],
			['Lilypad Path Part 3','Lilypad Path Part 2','',''],
		];
		var mapCropX = 0;
		var mapCropY = 0;
		loadMap('Starter House');
		loadMap('World');
		loadMap('House');
		loadMap('Cave');
		loadMap('Secret Base');
		loadMap('Secret Base Basement');
		loadMap('Cacti Farm');
		loadMap('The Guarded Citadel');
		
		var mapChange = 0;
		var mapDirection = 'up';
		var mapSlide = 0;
		var lastMap = '';
		var currentMap = '';
		var drewMap = false;
		var isWorldMap = false;

		var talking = false;
		var selfId = null;

		var state = {
			isDragging: false,
			isHidden: true,
			xDiff: 0,
			yDiff: 0,
			x: 50,
			y: 50
		};

		// hehe: http://youmightnotneedjquery.com/
		function ready(fn){
			if(document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading"){
				fn();
			}
			else{
				document.addEventListener('DOMContentLoaded', fn);
			}
		}

		function renderWindow(w,myState){
			if(state.isHidden){
				w.style.display = 'none';
			}
			else{
				w.style.display = '';
			}

			w.style.transform = 'translate(' + myState.x + 'px, ' + myState.y + 'px)';
		}

		function clampX(n){
			return Math.min(Math.max(n,0),window.innerWidth - 600);
		}

		function clampY(n){
			return Math.min(Math.max(n,0),window.innerHeight - 45);
		}

		function onMouseMove(e){
			if(state.isDragging){
				state.x = clampX(e.pageX - state.xDiff);
				state.y = clampY(e.pageY - state.yDiff);
			}

			// Update window position
			var w = document.getElementById('window');
			renderWindow(w,state);
		}

		function onMouseDown(e){
			state.isDragging = true;
			state.xDiff = e.pageX - state.x;
			state.yDiff = e.pageY - state.y;
		}

		function onMouseUp(){
			state.isDragging = false;
		}

		function closeWindow(){
			state.isHidden = true;
			menu = 'none';

			var w = document.getElementById('window');
			renderWindow(w,state);
		}

		ready(function(){
			var w = document.getElementById('window');
			renderWindow(w,state);

			var windowBar = document.querySelectorAll('.window-bar');
			windowBar[0].addEventListener('mousedown',onMouseDown);
			document.addEventListener('mousemove',onMouseMove);
			document.addEventListener('mouseup',onMouseUp);

			var closeButton = document.querySelectorAll('.window-close');
			closeButton[0].addEventListener('click',closeWindow);

			var toggleButton = document.getElementById('windowtoggle');
			toggleButton.addEventListener('click',function() {
				state.isHidden = !state.isHidden;
				if(menu !== 'inventory'){
					menu = 'inventory';
				}
				else{
					menu = 'none';
				}
				renderWindow(w,state);
			});
		});

		var respawn = function(){
			socket.emit('respawn');
			STATE = 'respawn';
			setTimeout(function(){
				STATE = 'game';
			},50);
		}
		var questInventory = new QuestInventory(socket,false);
		socket.on('updateQuestInventory',function(items){
			questInventory.items = items;
			questInventory.refreshRender();
		});
		var inventory = new Inventory(socket,false);
		socket.on('updateInventory',function(pack){
			inventory.items = pack.items;
			inventory.currentEquip = pack.currentEquip;
			inventory.refreshRender();
		});
		document.getElementById('debugButton').onclick = function(){
			menu = 'debug';
			document.getElementById('inventory').style.display = 'none';
			document.getElementById('statScreen').style.display = 'none';
			document.getElementById('questScreen').style.display = 'none';
			document.getElementById('worldMap').style.display = 'none';
			document.getElementById('debugScreen').style.display = 'inline-block';
		}
		document.getElementById('inventoryButton').onclick = function(){
			menu = 'inventory';
			document.getElementById('debugScreen').style.display = 'none';
			document.getElementById('statScreen').style.display = 'none';
			document.getElementById('questScreen').style.display = 'none';
			document.getElementById('worldMap').style.display = 'none';
			document.getElementById('inventory').style.display = 'inline-block';
		}
		document.getElementById('statButton').onclick = function(){
			menu = 'stat';
			document.getElementById('inventory').style.display = 'none';
			document.getElementById('debugScreen').style.display = 'none';
			document.getElementById('questScreen').style.display = 'none';
			document.getElementById('worldMap').style.display = 'none';
			document.getElementById('statScreen').style.display = 'inline-block';
		}
		document.getElementById('worldMapButton').onclick = function(){
			menu = 'worldMap';
			document.getElementById('inventory').style.display = 'none';
			document.getElementById('debugScreen').style.display = 'none';
			document.getElementById('questScreen').style.display = 'none';
			document.getElementById('statScreen').style.display = 'none';
			document.getElementById('worldMap').style.display = 'inline-block';
		}
		
		var Player = function(initPack){
			var self = {};
			self.id = initPack.id;
			self.username = initPack.username;
			self.x = initPack.x;
			self.y = initPack.y;
			self.moveX = 0;
			self.moveY = 0;
			self.nextX = initPack.x;
			self.nextY = initPack.y;
			self.spdX = initPack.spdX;
			self.spdY = initPack.spdY;
			self.img = initPack.img;
			self.direction = initPack.direction;
			self.hp = initPack.hp;
			self.hpMax = initPack.hpMax;
			self.xp = initPack.xp;
			self.xpMax = initPack.xpMax;
			self.level = initPack.level;
			self.map = initPack.map;
			self.attackReload = initPack.attackReload;
			self.secondReload = initPack.secondReload;
			self.healReload = initPack.healReload;
			self.mapHeight = initPack.mapWidth;
			self.mapWidth = initPack.mapHeight;
			self.updated = true;
			self.animation = initPack.animation;
			self.animationDirection = initPack.animationDirection;
			self.stats = initPack.stats;
			self.type = initPack.type;
			self.moveSpeed = 15;
			self.update = function(){
				if(talking && self.id === selfId){
					socket.emit('keyPress',{inputId:'releaseAll'});
					return;
				}
				if(self.x !== self.nextX){
					self.x += self.moveX;
				}
				if(self.y !== self.nextY){
					self.y += self.moveY;
				}
			}
			self.draw = function(){
				self.animation = Math.round(self.animation);
				if(DEBUG === 2){
					ctx.strokeStyle = '#000000';
					ctx.lineWidth = 4;
					ctx.strokeRect(self.x - 10,self.y - 12,20,24);
					return;
				}
				switch(self.animationDirection){
					case "down":
						ctx.drawImage(Img.player,96 * self.animation,152 * 0,96,152,self.x - 24,self.y - 58,48,76);
						break;
					case "rightdown":
						ctx.drawImage(Img.player,96 * self.animation,152 * 1,96,152,self.x - 24,self.y - 58,48,76);
						break;
					case "right":
						ctx.drawImage(Img.player,96 * self.animation,152 * 2,96,152,self.x - 24,self.y - 58,48,76);
						break;
					case "rightup":
						ctx.drawImage(Img.player,96 * self.animation,152 * 3,96,152,self.x - 24,self.y - 58,48,76);
						break;
					case "up":
						ctx.drawImage(Img.player,96 * self.animation,152 * 4,96,152,self.x - 24,self.y - 58,48,76);
						break;
					case "leftup":
						ctx.drawImage(Img.player,96 * self.animation,152 * 5,96,152,self.x - 24,self.y - 58,48,76);
						break;
					case "left":
						ctx.drawImage(Img.player,96 * self.animation,152 * 6,96,152,self.x - 24,self.y - 58,48,76);
						break;
					case "leftdown":
						ctx.drawImage(Img.player,96 * self.animation,152 * 7,96,152,self.x - 24,self.y - 58,48,76);
						break;
				}
				if(DEBUG !== 0){
					ctx.strokeStyle = '#000000';
					ctx.lineWidth = 4;
					ctx.strokeRect(self.x - 10,self.y - 12,20,24);
				}
				if(self.id === selfId){
					inventoryPlayerDisplay.clearRect(0,0,96,152);
					switch(self.animationDirection){
						case "down":
							inventoryPlayerDisplay.drawImage(Img.player,96 * self.animation,152 * 0,96,152,0,0,96,152);
							break;
						case "rightdown":
							inventoryPlayerDisplay.drawImage(Img.player,96 * self.animation,152 * 1,96,152,0,0,96,152);
							break;
						case "right":
							inventoryPlayerDisplay.drawImage(Img.player,96 * self.animation,152 * 2,96,152,0,0,96,152);
							break;
						case "rightup":
							inventoryPlayerDisplay.drawImage(Img.player,96 * self.animation,152 * 3,96,152,0,0,96,152);
							break;
						case "up":
							inventoryPlayerDisplay.drawImage(Img.player,96 * self.animation,152 * 4,96,152,0,0,96,152);
							break;
						case "leftup":
							inventoryPlayerDisplay.drawImage(Img.player,96 * self.animation,152 * 5,96,152,0,0,96,152);
							break;
						case "left":
							inventoryPlayerDisplay.drawImage(Img.player,96 * self.animation,152 * 6,96,152,0,0,96,152);
							break;
						case "leftdown":
							inventoryPlayerDisplay.drawImage(Img.player,96 * self.animation,152 * 7,96,152,0,0,96,152);
							break;
					}
				}
			}
			self.drawName = function(){
				if(self.img === 'dead'){
					return;
				}
				ctx.font = "15px pixel";
				ctx.fillStyle = '#ff7700';
				ctx.textAlign = "center";
				ctx.fillText(self.username,self.x - 1,self.y - 80);
				ctx.drawImage(Img.healthBar,0,0,168,20,self.x - 63,self.y - 70,126,15);
				ctx.drawImage(Img.healthBar,0,24,168 * self.hp / self.hpMax,20,self.x - 63,self.y - 70,126 * self.hp / self.hpMax,15);
				if(self.id !== selfId){
					return;
				}
				if(self.attackReload > 14){
					self.attackReload = 25;
					mainAttackDiv.style.color = "#25ff25";
				}
				else{
					mainAttackDiv.style.color = "#ff2525";
				}
				if(self.secondReload > 249){
					self.secondReload = 250;
					secondaryAttackDiv.style.color = "#25ff25";
				}
				else{
					secondaryAttackDiv.style.color = "#ff2525";
				}
				if(self.healReload > 449){
					self.healReload = 500;
					healDiv.style.color = "#25ff25";
				}
				else{
					healDiv.style.color = "#ff2525";
				}
				mainAttackDiv.innerHTML = "Main Attack: " + self.attackReload / 25;
				secondaryAttackDiv.innerHTML = "Secondary Attack: " + self.secondReload / 25;
				healDiv.innerHTML = "Heal: " + self.healReload / 25;
				healthBarText.innerHTML = self.hp + " / " + self.hpMax;
				healthBarValue.style.width = "" + 150 * self.hp / self.hpMax;
				var xpText = self.xp + " ";
				var xpMaxText = "/ " + self.xpMax;
				if(self.xp > 999999999999999){
					xpText = Math.round(self.xp / 100000000000000) / 10 + "Q ";
				}
				else if(self.xp > 999999999999){
					xpText = Math.round(self.xp / 100000000000) / 10 + "T ";
				}
				else if(self.xp > 999999999){
					xpText = Math.round(self.xp / 100000000) / 10 + "B ";
				}
				else if(self.xp > 999999){
					xpText = Math.round(self.xp / 100000) / 10 + "M ";
				}
				else if(self.xp > 9999){
					xpText = Math.round(self.xp / 1000) + "K ";
				}
				if(self.xpMax > 999999999999999){
					xpMaxText = "/ " + Math.round(self.xpMax / 100000000000000) / 10 + "Q";
				}
				else if(self.xpMax > 999999999999){
					xpMaxText = "/ " + Math.round(self.xpMax / 100000000000) / 10 + "T";
				}
				else if(self.xpMax > 999999999){
					xpMaxText = "/ " + Math.round(self.xpMax / 100000000) / 10 + "B";
				}
				else if(self.xpMax > 999999){
					xpMaxText = "/ " + Math.round(self.xpMax / 100000) / 10 + "M";
				}
				else if(self.xpMax > 9999){
					xpMaxText = "/ " + Math.round(self.xpMax / 1000) + "K";
				}
				xpBarText.innerHTML = xpText + xpMaxText;
				xpBarValue.style.width = "" + 150 * self.xp / self.xpMax;
				document.getElementById('stat-attack').innerHTML = 'You will deal a miminum of ' + Math.round(50 * self.stats.attack) + ' damage and a maximum of ' + Math.round(100 * self.stats.attack) + ' damage.';
				document.getElementById('stat-defense').innerHTML = 'Out of 100 damage, you will receive ' + Math.round(100 / self.stats.defense) + ' damage.<br>You are level ' + self.level + '.<br>You will get ' + Math.round(self.stats.xp * 10) + ' xp per monster killed.';
			}
			self.drawLight = function(){
				if(self.id !== selfId){
					return;
				}
				if(self.map !== "Cave"){
					return;
				}
				var grd = ctx.createRadialGradient(self.x,self.y,50,self.x,self.y,500);
				grd.addColorStop(0,"rgba(0,0,0,0)");
				grd.addColorStop(1,"rgba(0,0,0,1)");
				ctx.fillStyle = grd;
				ctx.fillRect(self.x - WIDTH,self.y - HEIGHT,WIDTH * 2,HEIGHT * 2);
			}
			Player.list[self.id] = self;
			return self;
		}
		Player.list = {};
		var Projectile = function(initPack){
			var self = {};
			self.id = initPack.id;
			self.x = initPack.x;
			self.y = initPack.y;
			self.nextX = initPack.x;
			self.nextY = initPack.y;
			self.moveX = 0;
			self.moveY = 0;
			self.spdX = initPack.spdX;
			self.spdY = initPack.spdY;
			self.direction = initPack.direction;
			self.projectileType = initPack.projectileType;
			self.type = initPack.type;
			self.hp = initPack.hp;
			self.hpMax = initPack.hpMax;
			self.map = initPack.map;
			self.updated = true;
			self.update = function(){
				self.x += self.moveX;
				self.y += self.moveY;
				/*if(self.realX - self.x >= 40){
					self.x = self.realX;
				}
				else if(self.realX - self.x >= 5){
					self.x += 5;
				}
				else if(self.realX - self.x <= -40){
					self.x = self.realX;
				}
				else if(self.realX - self.x <= -5){
					self.x -= 5;
				}
				else{
					self.x = self.realX;
				}
				if(self.realY - self.y >= 40){
					self.y = self.realY;
				}
				else if(self.realY - self.y >= 5){
					self.y += 5;
				}
				else if(self.realY - self.y <= -40){
					self.y = self.realY;
				}
				else if(self.realY - self.y <= -5){
					self.y -= 5;
				}
				else{
					self.y = self.realY;
				}*/
			}
			self.draw = function(){
				if(DEBUG === 2){
					ctx.strokeStyle = '#000000';
					ctx.lineWidth = 4;
					ctx.strokeRect(self.x - 22,self.y - 22,44,44);
					return;
				}
				ctx.translate(self.x,self.y);
				ctx.rotate(self.direction * Math.PI / 180);
				var i = new Image();
				i.src = '/client/img/' + self.projectileType + '.png';
				ctx.drawImage(i,-24,-24);
				ctx.rotate(-self.direction * Math.PI / 180);
				ctx.translate(-self.x,-self.y);
				if(DEBUG !== 0){
					ctx.strokeStyle = '#000000';
					ctx.lineWidth = 4;
					ctx.strokeRect(self.x - 22,self.y - 22,44,44);
				}
			}
			Projectile.list[self.id] = self;
			return self;
		}
		Projectile.list = {};
		var Monster = function(initPack){
			var self = {};
			self.id = initPack.id;
			self.x = initPack.x;
			self.y = initPack.y;
			self.nextX = initPack.x;
			self.nextY = initPack.y;
			self.moveX = 0;
			self.moveY = 0;
			self.hp = initPack.hp;
			self.hpMax = initPack.hpMax;
			self.map = initPack.map;
			self.monsterType = initPack.monsterType;
			self.type = initPack.type;
			self.updated = true;
			self.update = function(){
				self.x += self.moveX;
				self.y += self.moveY;
			}
			self.draw = function(){
				if(DEBUG === 2){
					ctx.strokeStyle = '#000000';
					ctx.lineWidth = 4;
					ctx.strokeRect(self.x - 10,self.y - 4,20,20);
					return;
				}
				if(self.monsterType === 'purple'){
					ctx.drawImage(Img.monster,self.x - 12,self.y - 18);
				}
				else if(self.monsterType === 'green'){
					ctx.drawImage(Img.monsterGreen,self.x - 12,self.y - 18);
				}
				else if(self.monsterType === 'blue'){
					ctx.drawImage(Img.monsterBlue,self.x - 12,self.y - 18);
				}
				else if(self.monsterType === 'red'){
					ctx.drawImage(Img.monsterBoss,self.x - 24,self.y - 36);
				}
				else if(self.monsterType === 'orange'){
					ctx.drawImage(Img.monsterOrange,self.x - 48,self.y - 72);
				}
				else if(self.monsterType === 'white'){
					ctx.drawImage(Img.monsterWhite,self.x - 6,self.y - 9);
				}
				else if(self.monsterType === 'black'){
					ctx.drawImage(Img.monsterWhite,self.x - 6,self.y - 9);
				}
				if(DEBUG !== 0){
					ctx.strokeStyle = '#000000';
					ctx.lineWidth = 4;
					ctx.strokeRect(self.x - 10,self.y - 4,20,20);
				}
			}
			self.drawHp = function(){
				if(self.monsterType === 'red'){
					ctx.drawImage(Img.healthBarEnemy,0,0,168,20,self.x - 63,self.y - 65,126,15);
					ctx.drawImage(Img.healthBarEnemy,0,24,168 * self.hp / self.hpMax,20,self.x - 63,self.y - 65,126 * self.hp / self.hpMax,15);
				}
				else if(self.monsterType === 'orange'){
					ctx.drawImage(Img.healthBarEnemy,0,0,168,20,self.x - 63,self.y - 95,126,15);
					ctx.drawImage(Img.healthBarEnemy,0,24,168 * self.hp / self.hpMax,20,self.x - 63,self.y - 95,126 * self.hp / self.hpMax,15);
				}
				else if(self.monsterType === 'white'){
					ctx.drawImage(Img.healthBarEnemy,0,0,168,20,self.x - 63,self.y - 35,126,15);
					ctx.drawImage(Img.healthBarEnemy,0,24,168 * self.hp / self.hpMax,20,self.x - 63,self.y - 35,126 * self.hp / self.hpMax,15);
				}
				else{
					ctx.drawImage(Img.healthBarEnemy,0,0,168,20,self.x - 63,self.y - 45,126,15);
					ctx.drawImage(Img.healthBarEnemy,0,24,168 * self.hp / self.hpMax,20,self.x - 63,self.y - 45,126 * self.hp / self.hpMax,15);
				}
			}
			Monster.list[self.id] = self;
			return self;
		}
		Monster.list = {};
		var Npc = function(initPack){
			var self = {};
			self.id = initPack.id;
			self.x = initPack.x;
			self.y = initPack.y;
			self.nextX = initPack.x;
			self.nextY = initPack.y;
			self.moveX = 0;
			self.moveY = 0;
			self.img = initPack.img;
			self.hp = initPack.hp;
			self.animation = initPack.animation;
			self.animationDirection = initPack.animationDirection;
			self.hpMax = initPack.hpMax;
			self.map = initPack.map;
			self.name = initPack.name;
			self.type = initPack.type;
			self.updated = true;
			self.update = function(){
				if(self.x !== self.nextX){
					self.x += self.moveX;
				}
				if(self.y !== self.nextY){
					self.y += self.moveY;
				}
			}
			self.draw = function(){
				if(DEBUG === 2){
					ctx.strokeStyle = '#000000';
					ctx.lineWidth = 4;
					ctx.strokeRect(self.x - 10,self.y - 12,20,24);
					return;
				}
				self.animation = Math.round(self.animation);
				var image;
				if(self.img === 'Npc'){
					image = Img.npc;
				}
				switch(self.animationDirection){
					case "down":
						ctx.drawImage(Img.npc,96 * self.animation,152 * 0,96,152,self.x - 24,self.y - 58,48,76);
						break;
					case "rightdown":
						ctx.drawImage(Img.npc,96 * self.animation,152 * 1,96,152,self.x - 24,self.y - 58,48,76);
						break;
					case "right":
						ctx.drawImage(Img.npc,96 * self.animation,152 * 2,96,152,self.x - 24,self.y - 58,48,76);
						break;
					case "rightup":
						ctx.drawImage(Img.npc,96 * self.animation,152 * 3,96,152,self.x - 24,self.y - 58,48,76);
						break;
					case "up":
						ctx.drawImage(Img.npc,96 * self.animation,152 * 4,96,152,self.x - 24,self.y - 58,48,76);
						break;
					case "leftup":
						ctx.drawImage(Img.npc,96 * self.animation,152 * 5,96,152,self.x - 24,self.y - 58,48,76);
						break;
					case "left":
						ctx.drawImage(Img.npc,96 * self.animation,152 * 6,96,152,self.x - 24,self.y - 58,48,76);
						break;
					case "leftdown":
						ctx.drawImage(Img.npc,96 * self.animation,152 * 7,96,152,self.x - 24,self.y - 58,48,76);
						break;
				}
				if(DEBUG !== 0){
					ctx.strokeStyle = '#000000';
					ctx.lineWidth = 4;
					ctx.strokeRect(self.x - 10,self.y - 12,20,24);
				}
				ctx.font = "15px pixel";
				ctx.fillStyle = '#ff7700';
				ctx.textAlign = "center";
				ctx.fillText(self.name,self.x,self.y - 58);
			}
			Npc.list[self.id] = self;
			return self;
		}
		Npc.list = {};
		socket.on('selfId',function(data){
			selfId = data.id;
		});
		socket.on('update',function(data){
			for(var i in Player.list){
				Player.list[i].updated = false;
			}
			for(var i in Projectile.list){
				Projectile.list[i].updated = false;
			}
			for(var i in Monster.list){
				Monster.list[i].updated = false;
			}
			for(var i in Npc.list){
				Npc.list[i].updated = false;
			}
			if(data){
				if(data.player.length > 0){
					for(var i = 0;i < data.player.length;i++){
						if(Player.list[data.player[i].id]){
							Player.list[data.player[i].id].moveX = 0;
							Player.list[data.player[i].id].moveY = 0;
							if(data.player[i].x){
								Player.list[data.player[i].id].nextX = data.player[i].x;
							}
							Player.list[data.player[i].id].moveX = (Player.list[data.player[i].id].nextX - Player.list[data.player[i].id].x) / 4;
							if(data.player[i].y){
								Player.list[data.player[i].id].nextY = data.player[i].y;
							}
							Player.list[data.player[i].id].moveY = (Player.list[data.player[i].id].nextY - Player.list[data.player[i].id].y) / 4;
							if(data.player[i].spdX){
								Player.list[data.player[i].id].spdX = data.player[i].spdX;
							}
							if(data.player[i].spdY){
								Player.list[data.player[i].id].spdY = data.player[i].spdY;
							}
							if(data.player[i].img){
								Player.list[data.player[i].id].img = data.player[i].img;
							}
							if(data.player[i].animationDirection){
								Player.list[data.player[i].id].animationDirection = data.player[i].animationDirection;
							}
							if(data.player[i].direction){
								Player.list[data.player[i].id].direction = data.player[i].direction;
							}
							if(data.player[i].hp){
								Player.list[data.player[i].id].hp = data.player[i].hp;
							}
							if(data.player[i].hpMax){
								Player.list[data.player[i].id].hpMax = data.player[i].hpMax;
							}
							if(data.player[i].xp){
								Player.list[data.player[i].id].xp = data.player[i].xp;
							}
							if(data.player[i].xpMax){
								Player.list[data.player[i].id].xpMax = data.player[i].xpMax;
							}
							if(data.player[i].level){
								Player.list[data.player[i].id].level = data.player[i].level;
							}
							if(data.player[i].map){
								Player.list[data.player[i].id].map = data.player[i].map;
							}
							if(data.player[i].attackReload){
								Player.list[data.player[i].id].attackReload = data.player[i].attackReload;
							}
							if(data.player[i].secondReload){
								Player.list[data.player[i].id].secondReload = data.player[i].secondReload;
							}
							if(data.player[i].healReload){
								Player.list[data.player[i].id].healReload = data.player[i].healReload;
							}
							if(data.player[i].mapWidth){
								Player.list[data.player[i].id].mapWidth = data.player[i].mapWidth;
							}
							if(data.player[i].mapHeight){
								Player.list[data.player[i].id].mapHeight = data.player[i].mapHeight;
							}
							if(data.player[i].stats){
								Player.list[data.player[i].id].stats = data.player[i].stats;
							}
							if(data.player[i].animation){
								Player.list[data.player[i].id].animation = data.player[i].animation;
							}
							else{
								Player.list[data.player[i].id].animation = 0;
							}
							Player.list[data.player[i].id].updated = true;
						}
						else{
							new Player(data.player[i]);
						}
					}
				}
				if(data.projectile.length > 0){
					for(var i = 0;i < data.projectile.length;i++){
						if(Projectile.list[data.projectile[i].id]){
							Projectile.list[data.projectile[i].id].moveX = 0;
							Projectile.list[data.projectile[i].id].moveY = 0;
							if(data.projectile[i].x){
								Projectile.list[data.projectile[i].id].nextX = data.projectile[i].x;
							}
							Projectile.list[data.projectile[i].id].moveX = (Projectile.list[data.projectile[i].id].nextX - Projectile.list[data.projectile[i].id].x) / 4;
							if(data.projectile[i].y){
								Projectile.list[data.projectile[i].id].nextY = data.projectile[i].y;
							}
							Projectile.list[data.projectile[i].id].moveY = (Projectile.list[data.projectile[i].id].nextY - Projectile.list[data.projectile[i].id].y) / 4;
							if(data.projectile[i].map){
								Projectile.list[data.projectile[i].id].map = data.projectile[i].map;
							}
							if(data.projectile[i].projectileType){
								Projectile.list[data.projectile[i].id].projectileType = data.projectile[i].projectileType;
							}
							if(data.projectile[i].direction){
								Projectile.list[data.projectile[i].id].direction = data.projectile[i].direction;
							}
							Projectile.list[data.projectile[i].id].updated = true;
						}
						else{
							new Projectile(data.projectile[i]);
						}
					}
				}
				if(data.monster.length > 0){
					for(var i = 0;i < data.monster.length;i++){
						if(Monster.list[data.monster[i].id]){
							Monster.list[data.monster[i].id].moveX = 0;
							Monster.list[data.monster[i].id].moveY = 0;
							if(data.monster[i].x){
								Monster.list[data.monster[i].id].nextX = data.monster[i].x;
							}
							Monster.list[data.monster[i].id].moveX = (Monster.list[data.monster[i].id].nextX - Monster.list[data.monster[i].id].x) / 4;
							if(data.monster[i].y){
								Monster.list[data.monster[i].id].nextY = data.monster[i].y;
							}
							Monster.list[data.monster[i].id].moveY = (Monster.list[data.monster[i].id].nextY - Monster.list[data.monster[i].id].y) / 4;
							if(data.monster[i].hp){
								Monster.list[data.monster[i].id].hp = data.monster[i].hp;
							}
							if(data.monster[i].hpMax){
								Monster.list[data.monster[i].id].hpMax = data.monster[i].hpMax;
							}
							Monster.list[data.monster[i].id].updated = true;
						}
						else{
							new Monster(data.monster[i]);
						}
					}
				}
				if(data.npc.length > 0){
					for(var i = 0;i < data.npc.length;i++){
						if(Npc.list[data.npc[i].id]){
							Npc.list[data.npc[i].id].moveX = 0;
							Npc.list[data.npc[i].id].moveY = 0;
							if(data.npc[i].x){
								Npc.list[data.npc[i].id].nextX = data.npc[i].x;
							}
							Npc.list[data.npc[i].id].moveX = (Npc.list[data.npc[i].id].nextX - Npc.list[data.npc[i].id].x) / 4;
							if(data.npc[i].y){
								Npc.list[data.npc[i].id].nextY = data.npc[i].y;
							}
							Npc.list[data.npc[i].id].moveY = (Npc.list[data.npc[i].id].nextY - Npc.list[data.npc[i].id].y) / 4;
							if(data.npc[i].animationDirection){
								Npc.list[data.npc[i].id].animationDirection = data.npc[i].animationDirection;
							}
							if(data.npc[i].hp){
								Npc.list[data.npc[i].id].hp = data.npc[i].hp;
							}
							if(data.npc[i].hpMax){
								Npc.list[data.npc[i].id].hpMax = data.npc[i].hpMax;
							}
							if(data.npc[i].animation){
								Npc.list[data.npc[i].id].animation = data.npc[i].animation;
							}
							else{
								Npc.list[data.npc[i].id].animation = 0;
							}
							Npc.list[data.npc[i].id].updated = true;
						}
						else{
							new Npc(data.npc[i]);
						}
					}
				}
			}
			for(var i in Player.list){
				if(Player.list[i].updated === false){
					delete Player.list[i];
				}
			}
			for(var i in Projectile.list){
				if(Projectile.list[i].updated === false){
					delete Projectile.list[i];
				}
			}
			for(var i in Monster.list){
				if(Monster.list[i].updated === false){
					delete Monster.list[i];
				}
			}
			for(var i in Npc.list){
				if(Npc.list[i].updated === false){
					delete Npc.list[i];
				}
			}
		});
		socket.on('initEntity',function(data){
			if(data.type === "Player"){
				new Player(data);
			}
			if(data.type === "Projectile"){
				new Projectile(data);
			}
			if(data.type === "Monster"){
				new Monster(data);
			}
			if(data.type === "Npc"){
				new Npc(data);
			}
		});
		socket.on('disconnected',function(data){
			STATE = 'disconnected';
			Player.list[selfId].moveX = 0;
			Player.list[selfId].moveY = 0;
			setTimeout(function(){
				location.reload();
			},5000);
		});
		socket.on('spectator',function(data){
			Player.list[selfId].hp = 0;
			if(STATE !== 'respawn'){
				STATE = 'spectator';
			}
			else{
				STATE = 'game';
			}
		});
		socket.on('changeMap',function(data){
			if(maps[data.teleport] !== undefined){
				shadeSpeed = 0.03;
				if(shadeAmount < 0){
					shadeAmount = 0;
				}
			}
			else if(maps[Player.list[selfId].map] !== undefined){
				shadeSpeed = 0.03;
				if(shadeAmount < 0){
					shadeAmount = 0;
				}
			}
			else{
				shadeSpeed = 0.03;
				if(shadeAmount < 0){
					shadeAmount = 0;
				}/*
				mapChange = 2;
				mapDirection = data.teleportdirection;
				lastMap = Player.list[selfId].map;
				currentMap = data.teleport;*/
			}
			lastMap = Player.list[selfId].map;
			currentMap = data.teleport;
			shadeSpeed = 3 / 40;
		});
		socket.on('dialougeLine',function(data){
			if(data.state === 'remove'){
				interactMenu.style.display = 'none';
				talking = false;
			}
			else{
				Player.list[selfId].moveX = 0;
				Player.list[selfId].moveY = 0;
				document.getElementById('interactMenuText').innerHTML = data.message;
				if(data.response1){
					document.getElementById('interactMenuButton1').innerHTML = data.response1;
					document.getElementById('interactMenuButton1').style.display = 'inline-block';
				}
				else{
					document.getElementById('interactMenuButton1').style.display = 'none';
				}
				if(data.response2){
					document.getElementById('interactMenuButton2').innerHTML = data.response2;
					document.getElementById('interactMenuButton2').style.display = 'inline-block';
				}
				else{
					document.getElementById('interactMenuButton2').style.display = 'none';
				}
				if(data.response3){
					document.getElementById('interactMenuButton3').innerHTML = data.response3;
					document.getElementById('interactMenuButton3').style.display = 'inline-block';
				}
				else{
					document.getElementById('interactMenuButton3').style.display = 'none';
				}
				if(data.response4){
					document.getElementById('interactMenuButton4').innerHTML = data.response4;
					document.getElementById('interactMenuButton4').style.display = 'inline-block';
				}
				else{
					document.getElementById('interactMenuButton4').style.display = 'none';
				}
				interactMenu.style.display = 'inline-block';
				talking = true;
			}
		});
		socket.on('questInfo',function(data){
			document.getElementById('questName').innerHTML = data.questName;
			document.getElementById('questDescription').innerHTML = data.questDescription;
			menu = 'quest';
			document.getElementById('inventory').style.display = 'none';
			document.getElementById('debugScreen').style.display = 'none';
			document.getElementById('statScreen').style.display = 'none';
			document.getElementById('questScreen').style.display = 'inline-block';
			document.getElementById('window').style.display = 'inline-block';
			state.isHidden = false;
		});
		
		startQuest = function(){
			socket.emit('startQuest');
			document.getElementById('window').style.display = 'none';
			state.isHidden = true;
		};

		var response = function(data){
			socket.emit('diolougeResponse',data);
		}
		
		setInterval(function(){
			if(STATE === 'signIn'){
				gameDiv.style.display = 'none';
				signDiv.style.display = 'inline-block';
				disconnectedDiv.style.display = 'none';
				spectatorDiv.style.display = 'none';
				adDiv.style.display = 'none';
			}
			if(STATE === 'disconnected'){
				gameDiv.style.display = 'inline-block';
				signDiv.style.display = 'none';
				disconnectedDiv.style.display = 'inline-block';
				spectatorDiv.style.display = 'none';
				adDiv.style.display = 'none';
			}
			if(STATE === 'spectator'){
				gameDiv.style.display = 'inline-block';
				signDiv.style.display = 'none';
				disconnectedDiv.style.display = 'none';
				spectatorDiv.style.display = 'inline-block';
				adDiv.style.display = 'inline-block';
				adDiv.style.display = 'none';
			}
			if(STATE === 'game'){
				gameDiv.style.display = 'inline-block';
				signDiv.style.display = 'none';
				disconnectedDiv.style.display = 'none';
				spectatorDiv.style.display = 'none';
				//adDiv.style.display = 'inline-block';
				adDiv.style.display = 'none';
			}
			if(STATE === 'respawn'){
				gameDiv.style.display = 'inline-block';
				signDiv.style.display = 'none';
				disconnectedDiv.style.display = 'none';
				spectatorDiv.style.display = 'none';
				adDiv.style.display = 'inline-block';
			}
			

			if(!selfId){
				return;
			}
			
			
			if(!Player.list[selfId]){
				return;
			}
			ctxRaw.style.width = window.innerWidth;
			ctxRaw.style.height = window.innerHeight;
			ctx.canvas.width = window.innerWidth;
			ctx.canvas.height = window.innerHeight;
			WIDTH = window.innerWidth;
			HEIGHT = window.innerHeight;
			ctx.fillStyle = maps[Player.list[selfId].map];
			ctx.fillRect(0,0,WIDTH,HEIGHT);
			lastCameraX = cameraX;
			lastCameraY = cameraY;
			cameraX = WIDTH/2 - Player.list[selfId].x;
			cameraY = HEIGHT/2 - Player.list[selfId].y;
			if(!talking){
				mouseCameraX = mouseX * Math.sqrt(Math.abs(mouseX)) / 1000;
				mouseCameraY = mouseY * Math.sqrt(Math.abs(mouseY)) / 1000;
			}
			/*if(lastCameraX - mouseCameraX > 2){
				mouseCameraX = lastCameraX - 2;
			}
			if(lastCameraX - mouseCameraX < -2){
				mouseCameraX = lastCameraX + 2;
			}
			if(lastCameraY - mouseCameraY > 2){
				mouseCameraY = lastCameraY - 2;
			}
			if(lastCameraY - mouseCameraY < -2){
				mouseCameraY = lastCameraY + 2;
			}
			*///cameraX -= mouseCameraX;
			//cameraY -= mouseCameraY;
			if(Player.list[selfId].mapWidth > window.innerWidth){
				if(cameraX > 0){
					cameraX = 0;
				}
				if(cameraX < WIDTH - Player.list[selfId].mapWidth){
					cameraX = WIDTH - Player.list[selfId].mapWidth;
				}
			}
			if(Player.list[selfId].mapHeight > window.innerHeight){
				if(cameraY > 0){
					cameraY = 0;
				}
				if(cameraY < HEIGHT - Player.list[selfId].mapHeight){
					cameraY = HEIGHT - Player.list[selfId].mapHeight;
				}
			}
			
			
			ctx.save();
			ctx.translate(Math.round(cameraX),Math.round(cameraY));
			//ctx.translate(cameraX,cameraY);
			
			if(!isWorldMap){
				if(loadedMap[Player.list[selfId].map]){
					ctx.drawImage(loadedMap[Player.list[selfId].map].lower,0,0);
				}
				else{
					loadMap(Player.list[selfId].map);
				}
			}
			else{
				if(loadedMap.World){
					ctx.drawImage(loadedMap.World.lower,mapCropX,mapCropY,3200,3200,0,0,3200,3200);
				}
				else{
					loadMap("World");
				}
			}
			
			ctx.restore();
			ctx.save();
			ctx.translate(cameraX,cameraY);
			var entities = [];
			for(var i in Player.list){
				entities.push(Player.list[i]);
			}
			for(var i in Projectile.list){
				entities.push(Projectile.list[i]);
			}
			for(var i in Monster.list){
				entities.push(Monster.list[i]);
			}
			for(var i in Npc.list){
				entities.push(Npc.list[i]);
			}
			function compare(a,b){
				var ay = a.y;
				var by = b.y;
				if(a.type === 'Player' || a.type === 'Npc'){
					ay -= 12;
				}
				if(b.type === 'Player' || b.type === 'Npc'){
					by -= 12;
				}
				if(ay < by){
					return -1;
				}
				if(ay > by){
					return 1;
				}
				return 0;
			}
			entities.sort(compare);
			for(var i = 0;i < entities.length;i++){
				entities[i].draw();
			}

			ctx.restore();
			ctx.save();
			ctx.translate(Math.round(cameraX),Math.round(cameraY));
			if(!isWorldMap){
				if(loadedMap[Player.list[selfId].map]){
					ctx.drawImage(loadedMap[Player.list[selfId].map].upper,0,0);
				}
				else{
					loadMap(Player.list[selfId].map);
				}
			}
			else{
				if(loadedMap.World){
					ctx.drawImage(loadedMap.World.upper,mapCropX,mapCropY,3200,3200,0,0,3200,3200);
				}
				else{
					loadMap("World");
				}
			}
			
			ctx.restore();
			ctx.save();
			ctx.translate(cameraX,cameraY);
			for(var i in Projectile.list){
				Projectile.list[i].update();
			}
			for(var i in Monster.list){
				Monster.list[i].drawHp();
				Monster.list[i].update();
			}
			for(var i in Npc.list){
				Npc.list[i].update();
			}
			for(var i in Player.list){
				Player.list[i].drawName();
			}
			for(var i in Player.list){
				Player.list[i].drawLight();
			}
			for(var i in Player.list){
				Player.list[i].update();
			}
			
			ctx.restore();
			if(mapShadeAmount >= 2){
				mapShadeSpeed = -0.12;
			}
			if(Player.list[selfId].map === currentMap && shadeAmount > 1.5){
				shadeSpeed = -3 / 40;
				isWorldMap = false;
				for(var i = 0;i < mapLocations.length;i++){
					for(var j = 0;j < mapLocations[i].length;j++){
						if(currentMap === mapLocations[i][j]){
							mapCropX = j * 3200;
							mapCropY = i * 3200;
							isWorldMap = true;
							currentMap = 'World';
						}
					}
				}
				if(!isWorldMap){
					mapCropX = 0;
					mapCropY = 0;
				}
			}
			if(shadeAmount < 0.25 && document.getElementById('mapName').innerHTML !== Player.list[selfId].map){
				document.getElementById('mapName').innerHTML = Player.list[selfId].map;
				mapShadeAmount = 0;
				mapShadeSpeed = 0.08;
			}
			shadeAmount += shadeSpeed;
			mapShadeAmount += mapShadeSpeed;
			blackShade.style.opacity = shadeAmount;
			document.getElementById('mapName').style.opacity = mapShadeAmount;

			worldMap.save();
			worldMapEntity.save();
			if(mapDrag){
				worldMap.fillStyle = '#000000';
				worldMap.fillRect(0,0,910,730);
				worldMap.translate(Math.round(mapX - 910 * (mapDragX - mapMouseX) / 600),Math.round(mapY - 910 * (mapDragY - mapMouseY) / 600));
				worldMap.drawImage(loadedMap.World.lower,0,0,mapRatio / 910 * 3200 * mapLocations[0].length,mapRatio / 910 * 3200 * mapLocations.length);
				worldMap.drawImage(loadedMap.World.upper,0,0,mapRatio / 910 * 3200 * mapLocations[0].length,mapRatio / 910 * 3200 * mapLocations.length);
			}
			if(isWorldMap){
				if(mapDrag){
					worldMapEntity.translate(Math.round(mapX - 910 * (mapDragX - mapMouseX) / 600),Math.round(mapY - 910 * (mapDragY - mapMouseY) / 600));
				}
				else{
					worldMapEntity.translate(Math.round(mapX),Math.round(mapY));
				}
				worldMapEntity.clearRect(0,0,100000,100000);
				for(var i in Player.list){
					worldMapEntity.translate((mapCropX + Player.list[i].x) * mapRatio / 910,(mapCropY + Player.list[i].y) * mapRatio / 910);
					worldMapEntity.rotate(Player.list[i].direction * Math.PI / 180);
					worldMapEntity.drawImage(Img.playericon,-56 * mapRatio / 910,-48 * mapRatio / 910,mapRatio / 10,mapRatio / 10);
					worldMapEntity.rotate(-1 * Player.list[i].direction * Math.PI / 180);
					worldMapEntity.translate(-1 * (mapCropX + Player.list[i].x) * mapRatio / 910,-1 * (mapCropY + Player.list[i].y) * mapRatio / 910);
				}
			}
			worldMap.restore();
			worldMapEntity.restore();
		},1000/80);
		
		function useMenuDropdown(){
			var dropdowns = document.getElementsByClassName("UI-dropdown-light");
			for(var i = 0;i < dropdowns.length;i++){
				var openDropdown = dropdowns[i];
				openDropdown.classList.toggle('dropdownShow');
			}
		}
		window.onclick = function(event){
			if(!event.target.matches('#menuDropdown')){
				var dropdowns = document.getElementsByClassName("UI-dropdown-light");
				for(var i = 0;i < dropdowns.length;i++){
					var openDropdown = dropdowns[i];
					if(openDropdown.classList.contains('dropdownShow')){
						openDropdown.classList.remove('dropdownShow');
					}
				}
			}
			if(!event.target.matches('#chat-input')){
				if(inChat){
					inChat = false;
				}
			}
		}
		document.onkeydown = function(event){
			if(chatPress){
			}
			else{
				if(event.keyCode === 66){
					if(DEBUG === 2){
						DEBUG = 0;
					}
					else{
						DEBUG += 1;
					}
				}
				else if(event.keyCode === 73){
					if(menu === 'none'){
						menu = 'inventory';
						inventoryDiv.style.display = 'inline-block';
					}
					else{
						menu = 'none';
						inventoryDiv.style.display = 'none';
					}
				}
				if(event.keyCode < 30){
					socket.emit('keyPress',{inputId:'releaseAll'});
				}
				if(event.keyCode > 32 && event.keyCode < 48){
					socket.emit('keyPress',{inputId:'releaseAll'});
				}
				if(event.keyCode > 57 && event.keyCode < 65){
					socket.emit('keyPress',{inputId:'releaseAll'});
				}
				if(event.keyCode > 90){
					socket.emit('keyPress',{inputId:'releaseAll'});
				}
				if(!talking){
					socket.emit('keyPress',{inputId:event.keyCode,state:true});
				}
			}
		}
		document.onkeyup = function(event){
			chatPress = false;
			if(!talking){
				socket.emit('keyPress',{inputId:event.keyCode,state:false});
			}
		}
		mouseDown = function(event){
			if(inChat){
				return;
			}
			if(event.button == 0){
				socket.emit('keyPress',{inputId:'attack',state:true});
			}
			if(event.button == 2){
				socket.emit('keyPress',{inputId:'second',state:true});
			}
		}
		mouseUp = function(event){
			if(event.button == 0){
				socket.emit('keyPress',{inputId:'attack',state:false});
			}
			if(event.button == 2){
				socket.emit('keyPress',{inputId:'second',state:false});
			}
		}
		mapMouseDown = function(event){
			mapDragX = mapMouseX;
			mapDragY = mapMouseY;
			mapDrag = true;
		}
		mapMouseUp = function(event){
			//mapDrag = false;
			//mapX = mapX + 2000 * (mouseX + WIDTH / 2 - mapMouseX) / 600;
			//mapY = mapY + 2000 * (mouseY + HEIGHT / 2 - mapMouseY) / 600;
		}
		document.addEventListener("visibilitychange",function(){
			var hidden = document.hidden;
			if(documentHidden === true && hidden === false){
				socket.emit('init');
			}
			if(hidden === true){
				socket.emit('keyPress',{inputId:"releaseAll",state:true});
			}
			documentHidden = document.hidden;
		});
		document.onmouseup = function(event){
			if(mapDrag){
				mapDrag = false;
				mapX = mapX - 910 * (mapDragX - mapMouseX) / 600;
				mapY = mapY - 910 * (mapDragY - mapMouseY) / 600;
			}
		}
		window.addEventListener('wheel',function(event){
			if(event.deltaY < 0 && mapRatio < 1300){
				mapRatio *= 1.1;
				mapX -= mapMouseX * 2;
				mapY -= mapMouseY * 2;
				mapX *= 1.1;
				mapY *= 1.1;
				mapX += mapMouseX * 2;
				mapY += mapMouseY * 2;
			}
			else if(event.deltaY > 0){
				mapRatio /= 1.1;
				mapX -= mapMouseX * 2;
				mapY -= mapMouseY * 2;
				mapX /= 1.1;
				mapY /= 1.1;
				mapX += mapMouseX * 2;
				mapY += mapMouseY * 2;
			}
			worldMap.save();
			worldMap.fillStyle = '#000000';
			worldMap.fillRect(0,0,910,730);
			worldMap.translate(Math.round(mapX),Math.round(mapY));
			worldMap.drawImage(loadedMap.World.lower,0,0,mapRatio / 910 * 3200 * mapLocations[0].length,mapRatio / 910 * 3200 * mapLocations.length);
			worldMap.drawImage(loadedMap.World.upper,0,0,mapRatio / 910 * 3200 * mapLocations[0].length,mapRatio / 910 * 3200 * mapLocations.length);
			worldMap.restore();
		});
		document.getElementById('worldMapEntityCanvas').onmousemove = function clickEvent(e){
			var rect = e.target.getBoundingClientRect();
			mapMouseX = e.clientX - rect.left;
			mapMouseY = e.clientY - rect.top;
		}
		document.onmousemove = function(event){
			if(Player.list[selfId]){
				var x = -1 * cameraX - Player.list[selfId].x + event.clientX;
				var y = -1 * cameraY - Player.list[selfId].y + event.clientY;
				if(event.clientY <= 0){
					socket.emit('keyPress',{inputId:'releaseAll'});
				}
				if(event.clientY >= window.innerHeight){
					socket.emit('keyPress',{inputId:'releaseAll'});
				}
				if(event.clientX <= 0){
					socket.emit('keyPress',{inputId:'releaseAll'});
				}
				if(event.clientX >= window.innerWidth){
					socket.emit('keyPress',{inputId:'releaseAll'});
				}
				mouseX = event.clientX - WIDTH / 2;
				mouseY = event.clientY - HEIGHT / 2;
				if(!talking){
					socket.emit('keyPress',{inputId:'direction',state:{x:x,y:y}});
				}
			}
		}
		document.querySelectorAll("button").forEach(function(item){
			item.addEventListener('focus',function(){
				this.blur();
			});
		});
		document.oncontextmenu = function(event){
			event.preventDefault();
		}
	</script>
</body>
</html>