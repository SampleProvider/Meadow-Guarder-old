<html>
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width">
	<title>Meadow Guarders</title>
	<link href="client/style.css" rel="stylesheet" type="text/css" >
	<style>
	</style>
</head>
<body>

	<div id="sign" style="display:inline-block;">
		<button id = "signIn" class="UI-button-light">Sign In</button>
		<label id="username-label" class="UI-text-light" for="username">Username:</label>
		<input class="UI-input-light" type="text" id="username" name="username" autocomplete="off"><br><br>
		<label id="password-label" class="UI-text-light" for="password">Password:</label>
		<input class="UI-input-light" type="password" id="password" name="password" autocomplete="off"><br><br>
		<button id ="createAccount" class="UI-button-light">Create Account</button>
		<button id ="deleteAccount" class="UI-button-light">Delete Account</button>
		<div id="signError"></div>
	</div>
	<div id="gameDiv" style="display:none;">
		<canvas id="ctx"></canvas>
		<div id="blackShade" onmousedown="mouseDown(event)" onmouseup="mouseUp(event)"></div>
		<div id="mapName" class="UI-text-light" onmousedown="mouseDown(event)" onmouseup="mouseUp(event)">Starter House</div>
		<div id="mainAttack" class="UI-text-light"></div>
		<div id="secondaryAttack" class="UI-text-light"></div>
		<div id="heal" class="UI-text-light"></div>
		<div id="questInventoryDiv" class="UI-text-light"></div>
		<div id="inventoryDiv" style="display:none;">
			<div id="inventoryPlayer" class="UI-text-light">
				<div id="inventoryPlayerName"></div>
				<canvas id="inventoryPlayerDisplay"></canvas>
			</div>
			<div id="inventoryItem"></div>
			<button id="inventoryExit">x</button>
		</div>
		<button id="inventoryButton" class="UI-button-light">Inventory [I]</button>
		<div id="selfDisplay">
			<div id="healthBar">
				<div id="healthBarValue"></div>
				<div id="healthBarText"></div>
			</div>
			<div id="magicBar"></div>
			<div id="xpBar"></div>
		</div>
		<div id="menu">
			<button id="menuDropdown" class="UI-button-light" onclick="useMenuDropdown()">Menu &#x25BC;</button>
			<div id="menuDropdownItem" class="UI-dropdown-light">
				<button id="signOut" class="UI-button-light" onclick="history.go(0)">Log Out</button>
			</div>
		</div>
		
		<div id="chat-text" class="UI-text-light" onmousedown="mouseDown(event)" onmouseup="mouseUp(event)">
			<div>Welcome to Meadow Guarders Open Snapshot 008d12b!</div>
		</div>

		<form id="chat-form" autocomplete="off">
			<input id="chat-input" class="UI-input-light" type="text"></input>
		</form>
	</div>
	<div id="spectator" style="display:none;">
		<div class="death-screen"></div>
		<button class="spectator">You're a spectator!</button>
		<button class="respawn" onclick="respawn()">Respawn</button>
	</div>
	<div id="ads" style="display:none">
		<button id="ad1" class="UI-button-light" onclick="disconnect()">Get FREE PlastiSnow!</button>
		<button id="ad2" class="UI-button-light" onclick="disconnect()">Do YOU want YOUR ad featured here? Then click <a href="https://forms.gle/stnavsadkja7r7b96">THIS LINK</a> to write a application!</button>
		<button id="ad3" class="UI-button-light" onclick="history.go(0)">Go to <a href="https://docs.google.com/forms/d/e/1FAIpQLSfyp_-6rxw0Kh-e4dru1Lpb6VRwoN2f_L_rawko3Hbm6n9KvQ/viewform">Tianmu's Lego center</a>! Get a free discount if your the first 100 People to get there!</button>
	</div>
	<div id="disconnected" style="display:none;">
		<button class="disconnected">Disconnected</button>
	</div>
	<script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
	<link href="/client/websiteAssets/MiniSet2.ttf@14d552ae72d147f7b96abae4220f32c0.woff" rel="stylesheet">

	<script src="https://cdn.socket.io/socket.io-1.4.5.js"></script>

	<!--<script src="/client/socket.js"></script>-->

	<script src="/client/Inventory.js"></script>
	<!--<script src="/socket.io/socket.io.js"></script>-->

	<script>
		var WIDTH = window.innerWidth;
		var HEIGHT = window.innerHeight;

		var cameraX = 0;
		var cameraY = 0;
		var lastCameraX = 0;
		var lastCameraY = 0;
		var mouseCameraX = 0;
		var mouseCameraY = 0;

		var menu = 'none';

		var RENDERDIST = 5;
		var STATE = 'signIn';

		var DEBUG = 0;
		
		var socket = io();

		var gameDiv = document.getElementById('gameDiv');
		var mainAttackDiv = document.getElementById('mainAttack');
		var secondaryAttackDiv = document.getElementById('secondaryAttack');
		var healDiv = document.getElementById('heal');
		var disconnectedDiv = document.getElementById('disconnected');
		var spectatorDiv = document.getElementById('spectator');
		var adDiv = document.getElementById('ads');
		var ctxRaw = document.getElementById('ctx');
		var inventoryPlayerDisplayRaw = document.getElementById('inventoryPlayerDisplay');
		var signDiv = document.getElementById('sign');
		var inventoryButton = document.getElementById('inventoryButton');
		var inventoryDiv = document.getElementById('inventoryDiv');
		var blackShade = document.getElementById('blackShade');
		var healthBarText = document.getElementById('healthBarText');
		var healthBarValue = document.getElementById('healthBarValue');
		var signDivUsername = document.getElementById('username');
		var signDivPassword = document.getElementById('password');
		var signDivSignIn = document.getElementById('signIn');
		var signDivCreateAccount = document.getElementById('createAccount');
		var signDivDeleteAccount = document.getElementById('deleteAccount');
		

		signDivSignIn.onclick = function(){
			socket.emit('signIn',{username:signDivUsername.value,password:signDivPassword.value});
		}
		signDivCreateAccount.onclick = function(){
			socket.emit('createAccount',{username:signDivUsername.value,password:signDivPassword.value});
		}
		signDivDeleteAccount.onclick = function(){
			socket.emit('deleteAccount',{username:signDivUsername.value});
		}
		socket.on('signInResponse',function(data){
			if(data.success == 2){
				document.getElementById('inventoryPlayerName').innerHTML = data.username;
				STATE = 'game';
			}
			else if(data.success == 1){
				alert("The account with username \'" + signDivUsername.value + "\' and password \'" + signDivPassword.value + "\' is already used. The other account will be disconnected shortly. Please try to sign again.");
			}
			else{
				alert("No account found with username \'" + signDivUsername.value + "\' and password \'" + signDivPassword.value + "\'.");
			}
		});
		socket.on('createAccountResponse',function(data){
			if(data.success == 1){
				alert("Account created with username \'" + signDivUsername.value + "\' and password \'" + signDivPassword.value + "\'.");
			}
			else if(data.success == 0){
				alert("Sorry, there is already an account with username \'" + signDivUsername.value + "\'.");
			}
			else if(data.success == 2){
				alert("Please use a username with 3+ characters.");
			}
			else if(data.success == 3){
				alert("Invalid characters.");
			}
		});
		socket.on('deleteAccountResponse',function(data){
			if(data.success == 1){
				alert("Deleted account created with username \'" + signDivUsername.value + "\'.");
			}
			else if(data.success == 0){
				alert("Sorry, there is no account with username \'" + signDivUsername.value + "\'.");
			}
		});
		
		var chatText = document.getElementById('chat-text');
		var chatInput = document.getElementById('chat-input');
		var chatForm = document.getElementById('chat-form');
		var chat = '<div>Welcome to Meadow Guarders Open Snapshot 008d12b!</div>';
		var chatPress = false;
		var inChat = false;

		socket.on('addToChat',function(data){
			var scroll = false;
			if(chatText.scrollTop + chatText.clientHeight >= chatText.scrollHeight - 5){
				scroll = true;
			}
			chat += '<div>' + data + '</div>';
			chatText.innerHTML = chat + '<br>';
			if(scroll){
				chatText.scrollTop = chatText.scrollHeight;
			}
		});
		chatForm.onsubmit = function(e){
			e.preventDefault();
			socket.emit('sendMsgToServer',chatInput.value);
			chatInput.value = '';
		}
		chatInput.onkeydown = function(e){
			chatPress = true;
		}
		chatInput.onmousedown = function(e){
			inChat = true;
		}

		var disconnect = function(){
			socket.emit("timeout");
		}
		var ctx = document.getElementById("ctx").getContext("2d");
		var inventoryPlayerDisplay = document.getElementById("inventoryPlayerDisplay").getContext("2d");
		ctx.canvas.width = window.innerWidth;
		ctx.canvas.height = window.innerHeight;
		ctx.canvas.width = 1536;
		ctx.canvas.height = 722;
		inventoryPlayerDisplay.canvas.width = 80;
		inventoryPlayerDisplay.canvas.height = 136;

		
		
		var maps = {};

		var load = function(name){
			return $.getJSON("/client/maps/" + name + ".json",function(json){
				maps[name] = json.backgroundcolor;
			});
		}
		load('Village');
		load('Starter House');
		load('Cave');
		load('House');
		load('River');
		load('Secret Base');
		load('Lilypad Path Part 1');
		load('The Outskirts');
		load('Lower Deadlands');
		var shadeSpeed = -0.01;
		var shadeAmount = 1;
		var mapShadeSpeed = 0;
		var mapShadeAmount = 0;
		var Img = {};
		Img.ghost = new Image();
		Img.ghost.src = '/client/img/ghost.png';
		Img.player = new Image();
		Img.player.src = '/client/img/Player Map Old.png';
		Img.playerDisplay = new Image();
		Img.playerDisplay.src = '/client/img/Untitled.png';
		Img.monster = new Image();
		Img.monster.src = '/client/img/Pet.png';
		Img.bullet = new Image();
		Img.bullet.src = '/client/img/Bullet.png';
		Img.healthBar = new Image();
		Img.healthBar.src = '/client/img/Health0.png';
		Img.healthBarEnemy = new Image();
		Img.healthBarEnemy.src = '/client/img/HealthEnemy.png';

		var mouseX = 0;
		var mouseY = 0;

		var mapChange = 0;
		var mapDirection = 'up';
		var mapSlide = 0;
		var lastMap = '';
		var currentMap = '';
		var drewMap = false;

		var selfId = null;

		var respawn = function(){
			socket.emit('respawn');
			STATE = 'respawn';
			setTimeout(function(){
				STATE = 'game';
			},50);
		}
		var questInventory = new QuestInventory(socket,false);
		socket.on('updateQuestInventory',function(items){
			questInventory.items = items;
			questInventory.refreshRender();
		});
		var inventory = new Inventory(socket,false);
		socket.on('updateInventory',function(items){
			inventory.items = items;
			inventory.refreshRender();
		});
		
		inventoryButton.onclick = function(){
			if(menu === 'none'){
				menu = 'inventory';
				inventoryDiv.style.display = 'inline-block';
			}
			else{
				menu = 'none';
				inventoryDiv.style.display = 'none';
			}
		}
		document.getElementById('inventoryExit').onclick = function(){
			menu = 'none';
			inventoryDiv.style.display = 'none';
		}
		var Player = function(initPack){
			var self = {};
			self.id = initPack.id;
			self.username = initPack.username;
			self.x = initPack.x;
			self.y = initPack.y;
			self.spdX = initPack.spdX;
			self.spdY = initPack.spdY;
			self.img = initPack.img;
			self.direction = initPack.direction;
			self.hp = initPack.hp;
			self.hpMax = initPack.hpMax;
			self.map = initPack.map;
			self.attackReload = initPack.attackReload;
			self.secondReload = initPack.secondReload;
			self.healReload = initPack.healReload;
			self.mapHeight = 640;
			self.mapWidth = 640;
			self.updated = true;
			self.animation = initPack.animation;
			self.animationDirection = initPack.animationDirection;
			
			self.draw = function(){
				self.animation = Math.round(self.animation);
				if(DEBUG === 2){
					ctx.strokeStyle = '#000000';
					ctx.lineWidth = 4;
					ctx.strokeRect(self.x - 10,self.y - 12,20,24);
					return;
				}
				switch(self.animationDirection){
					case "down":
						ctx.drawImage(Img.player,116 + 48 * self.animation,76 * 1,40,64,self.x - 20,self.y - 54,40,64);
						break;
					case "rightdown":
						ctx.drawImage(Img.player,116 + 48 * self.animation,76 * 2,40,64,self.x - 20,self.y - 54,40,64);
						break;
					case "right":
						ctx.drawImage(Img.player,116 + 48 * self.animation,76 * 3,40,64,self.x - 20,self.y - 54,40,64);
						break;
					case "rightup":
						ctx.drawImage(Img.player,116 + 48 * self.animation,76 * 4,40,64,self.x - 20,self.y - 54,40,64);
						break;
					case "up":
						ctx.drawImage(Img.player,116 + 48 * self.animation,76 * 5,40,64,self.x - 20,self.y - 54,40,64);
						break;
					case "leftup":
						ctx.drawImage(Img.player,116 + 48 * self.animation,76 * 6,40,64,self.x - 20,self.y - 54,40,64);
						break;
					case "left":
						ctx.drawImage(Img.player,116 + 48 * self.animation,76 * 7,40,64,self.x - 20,self.y - 54,40,64);
						break;
					case "leftdown":
						ctx.drawImage(Img.player,116 + 48 * self.animation,76 * 8,40,64,self.x - 20,self.y - 54,40,64);
						break;
				}
				if(DEBUG !== 0){
					ctx.strokeStyle = '#000000';
					ctx.lineWidth = 4;
					ctx.strokeRect(self.x - 10,self.y - 12,20,24);
				}
				if(self.id === selfId){
					inventoryPlayerDisplay.clearRect(0,0,80,136);
					switch(self.img){
						case "down":
							inventoryPlayerDisplay.drawImage(Img.playerDisplay,8 + 96 * 0,0,80,136,0,0,80,136);
							break;
						case "rightdown":
							inventoryPlayerDisplay.drawImage(Img.playerDisplay,8 + 96 * 1,0,80,136,0,0,80,136);
							break;
						case "right":
							inventoryPlayerDisplay.drawImage(Img.playerDisplay,8 + 96 * 2,0,80,136,0,0,80,136);
							break;
						case "rightup":
							inventoryPlayerDisplay.drawImage(Img.playerDisplay,8 + 96 * 3,0,80,136,0,0,80,136);
							break;
						case "up":
							inventoryPlayerDisplay.drawImage(Img.playerDisplay,8 + 96 * 4,0,80,136,0,0,80,136);
							break;
						case "leftup":
							inventoryPlayerDisplay.drawImage(Img.playerDisplay,8 + 96 * 5,0,80,136,0,0,80,136);
							break;
						case "left":
							inventoryPlayerDisplay.drawImage(Img.playerDisplay,8 + 96 * 6,0,80,136,0,0,80,136);
							break;
						case "leftdown":
							inventoryPlayerDisplay.drawImage(Img.playerDisplay,8 + 96 * 7,0,80,136,0,0,80,136);
							break;
					}
				}
			}
			self.drawName = function(){
				if(self.img === 'dead'){
					return;
				}
				ctx.font = "15px pixel";
				ctx.fillStyle = '#ff7700';
				ctx.textAlign = "center";
				ctx.fillText(self.username,self.x - 1,self.y - 80);
				ctx.drawImage(Img.healthBar,0,0,168,20,self.x - 63,self.y - 70,126,15);
				ctx.drawImage(Img.healthBar,0,24,168 * self.hp / self.hpMax,20,self.x - 63,self.y - 70,126 * self.hp / self.hpMax,15);
				if(self.id !== selfId){
					return;
				}
				if(self.attackReload > 14){
					self.attackReload = 25;
					mainAttackDiv.style.color = "#25ff25";
				}
				else{
					mainAttackDiv.style.color = "#ff2525";
				}
				if(self.secondReload > 249){
					self.secondReload = 250;
					secondaryAttackDiv.style.color = "#25ff25";
				}
				else{
					secondaryAttackDiv.style.color = "#ff2525";
				}
				if(self.healReload > 449){
					self.healReload = 500;
					healDiv.style.color = "#25ff25";
				}
				else{
					healDiv.style.color = "#ff2525";
				}
				mainAttackDiv.innerHTML = "Main Attack: " + self.attackReload / 25;
				secondaryAttackDiv.innerHTML = "Secondary Attack: " + self.secondReload / 25;
				healDiv.innerHTML = "Heal: " + self.healReload / 25;
				healthBarText.innerHTML = self.hp + " / " + self.hpMax;
				healthBarValue.style.width = "" + 150 * self.hp / self.hpMax;
				healthBarText.innerHTML = self.hp + " / " + self.hpMax;
				healthBarValue.style.width = "" + 150 * self.hp / self.hpMax;
				healthBarText.innerHTML = self.hp + " / " + self.hpMax;
				healthBarValue.style.width = "" + 150 * self.hp / self.hpMax;
			}
			self.drawLight = function(){
				if(self.id !== selfId){
					return;
				}
				if(self.map !== "Cave"){
					return;
				}
				var grd = ctx.createRadialGradient(self.x,self.y,50,self.x,self.y,500);
				grd.addColorStop(0,"rgba(0,0,0,0)");
				grd.addColorStop(1,"rgba(0,0,0,1)");
				ctx.fillStyle = grd;
				ctx.fillRect(self.x - WIDTH,self.y - HEIGHT,WIDTH * 2,HEIGHT * 2);
			}
			Player.list[self.id] = self;
			return self;
		}
		Player.list = {};
		var Projectile = function(initPack){
			var self = {};
			self.id = initPack.id;
			self.x = initPack.x;
			self.y = initPack.y;
			self.direction = initPack.direction;
			self.hp = initPack.hp;
			self.hpMax = initPack.hpMax;
			self.map = initPack.map;
			self.updated = true;
			self.draw = function(){
				if(DEBUG === 2){
					ctx.strokeStyle = '#000000';
					ctx.lineWidth = 4;
					ctx.strokeRect(self.x - 22,self.y - 22,44,44);
					return;
				}
				ctx.translate(self.x,self.y);
				ctx.rotate(self.direction * Math.PI / 180);
				ctx.drawImage(Img.bullet,-24,-24);
				ctx.rotate(-self.direction * Math.PI / 180);
				ctx.translate(-self.x,-self.y);
				if(DEBUG !== 0){
					ctx.strokeStyle = '#000000';
					ctx.lineWidth = 4;
					ctx.strokeRect(self.x - 22,self.y - 22,44,44);
				}
			}
			Projectile.list[self.id] = self;
			return self;
		}
		Projectile.list = {};
		var Monster = function(initPack){
			var self = {};
			self.id = initPack.id;
			self.x = initPack.x;
			self.y = initPack.y;
			self.hp = initPack.hp;
			self.hpMax = initPack.hpMax;
			self.map = initPack.map;
			self.updated = true;
			self.draw = function(){
				if(DEBUG === 2){
					ctx.strokeStyle = '#000000';
					ctx.lineWidth = 4;
					ctx.strokeRect(self.x - 10,self.y - 4,20,20);
					return;
				}
				ctx.drawImage(Img.monster,self.x - 12,self.y - 18);
				if(DEBUG !== 0){
					ctx.strokeStyle = '#000000';
					ctx.lineWidth = 4;
					ctx.strokeRect(self.x - 10,self.y - 4,20,20);
				}
			}
			self.drawHp = function(){
				ctx.drawImage(Img.healthBarEnemy,0,0,168,20,self.x - 63,self.y - 45,126,15);
				ctx.drawImage(Img.healthBarEnemy,0,24,168 * self.hp / self.hpMax,20,self.x - 63,self.y - 45,126 * self.hp / self.hpMax,15);
			}
			Monster.list[self.id] = self;
			return self;
		}
		Monster.list = {};
		socket.on('selfId',function(data){
			selfId = data;
		});
		socket.on('update',function(data){
			for(var i in Player.list){
				Player.list[i].updated = false;
			}
			for(var i in Projectile.list){
				Projectile.list[i].updated = false;
			}
			for(var i in Monster.list){
				Monster.list[i].updated = false;
			}
			if(data){
				for(var i = 0;i < data.player.length;i++){
					if(Player.list[data.player[i].id]){
						if(data.player[i].x){
							Player.list[data.player[i].id].x = data.player[i].x;
						}
						if(data.player[i].y){
							Player.list[data.player[i].id].y = data.player[i].y;
						}
						if(data.player[i].spdX){
							Player.list[data.player[i].id].spdX = data.player[i].spdX;
						}
						if(data.player[i].spdY){
							Player.list[data.player[i].id].spdY = data.player[i].spdY;
						}
						if(data.player[i].img){
							Player.list[data.player[i].id].img = data.player[i].img;
						}
						if(data.player[i].animationDirection){
							Player.list[data.player[i].id].animationDirection = data.player[i].animationDirection;
						}
						if(data.player[i].hp){
							Player.list[data.player[i].id].hp = data.player[i].hp;
						}
						if(data.player[i].hpMax){
							Player.list[data.player[i].id].hpMax = data.player[i].hpMax;
						}
						if(data.player[i].map){
							Player.list[data.player[i].id].map = data.player[i].map;
						}
						if(data.player[i].attackReload){
							Player.list[data.player[i].id].attackReload = data.player[i].attackReload;
						}
						if(data.player[i].secondReload){
							Player.list[data.player[i].id].secondReload = data.player[i].secondReload;
						}
						if(data.player[i].healReload){
							Player.list[data.player[i].id].healReload = data.player[i].healReload;
						}
						if(data.player[i].mapWidth){
							Player.list[data.player[i].id].mapWidth = data.player[i].mapWidth;
						}
						if(data.player[i].mapHeight){
							Player.list[data.player[i].id].mapHeight = data.player[i].mapHeight;
						}
						if(data.player[i].animation){
							Player.list[data.player[i].id].animation = data.player[i].animation;
						}
						else{
							Player.list[data.player[i].id].animation = 0;
						}
						Player.list[data.player[i].id].updated = true;
					}
					else{
						new Player(data.player[i]);
					}
				}
				if(data.projectile.length > 0){
					for(var i = 0;i < data.projectile.length;i++){
						if(Projectile.list[data.projectile[i].id]){
							if(data.projectile[i].x){
								Projectile.list[data.projectile[i].id].x = data.projectile[i].x;
							}
							if(data.projectile[i].y){
								Projectile.list[data.projectile[i].id].y = data.projectile[i].y;
							}
							if(data.projectile[i].map){
								Projectile.list[data.projectile[i].id].map = data.projectile[i].map;
							}
							Projectile.list[data.projectile[i].id].updated = true;
						}
						else{
							new Projectile(data.projectile[i]);
						}
					}
				}
				if(data.monster.length > 0){
					for(var i = 0;i < data.monster.length;i++){
						if(Monster.list[data.monster[i].id]){
							if(data.monster[i].x){
								Monster.list[data.monster[i].id].x = data.monster[i].x;
							}
							if(data.monster[i].y){
								Monster.list[data.monster[i].id].y = data.monster[i].y;
							}
							if(data.monster[i].hp){
								Monster.list[data.monster[i].id].hp = data.monster[i].hp;
							}
							if(data.monster[i].hpMax){
								Monster.list[data.monster[i].id].hpMax = data.monster[i].hpMax;
							}
							Monster.list[data.monster[i].id].updated = true;
						}
						else{
							new Monster(data.monster[i]);
						}
					}
				}
			}
			for(var i in Player.list){
				if(Player.list[i].updated === false){
					delete Player.list[i];
				}
			}
			for(var i in Projectile.list){
				if(Projectile.list[i].updated === false){
					delete Projectile.list[i];
				}
			}
			for(var i in Monster.list){
				if(Monster.list[i].updated === false){
					delete Monster.list[i];
				}
			}
		});
		socket.on('disconnected',function(data){
			STATE = 'disconnected';
			setTimeout(function(){
				location.reload();
			},5000);
		});
		socket.on('spectator',function(data){
			if(STATE !== 'respawn'){
				STATE = 'spectator';
			}
			else{
				STATE = 'game';
			}
		});
		socket.on('changeMap',function(data){
			if(maps[data.teleport] !== undefined){
				shadeSpeed = 0.08;
				if(shadeAmount < 0){
					shadeAmount = 0;
				}
			}
			else if(maps[Player.list[selfId].map] !== undefined){
				shadeSpeed = 0.08;
				if(shadeAmount < 0){
					shadeAmount = 0;
				}
			}
			else{
				mapChange = 2;
				mapDirection = data.teleportdirection;
				lastMap = Player.list[selfId].map;
				currentMap = data.teleport;
			}
			lastMap = Player.list[selfId].map;
			currentMap = data.teleport;
		});
		setInterval(function(){
			if(STATE === 'signIn'){
				gameDiv.style.display = 'none';
				signDiv.style.display = 'inline-block';
				disconnectedDiv.style.display = 'none';
				spectatorDiv.style.display = 'none';
				adDiv.style.display = 'none';
			}
			if(STATE === 'disconnected'){
				gameDiv.style.display = 'inline-block';
				signDiv.style.display = 'none';
				disconnectedDiv.style.display = 'inline-block';
				spectatorDiv.style.display = 'none';
				adDiv.style.display = 'none';
			}
			if(STATE === 'spectator'){
				gameDiv.style.display = 'inline-block';
				signDiv.style.display = 'none';
				disconnectedDiv.style.display = 'none';
				spectatorDiv.style.display = 'inline-block';
				adDiv.style.display = 'inline-block';
				adDiv.style.display = 'none';
			}
			if(STATE === 'game'){
				gameDiv.style.display = 'inline-block';
				signDiv.style.display = 'none';
				disconnectedDiv.style.display = 'none';
				spectatorDiv.style.display = 'none';
				//adDiv.style.display = 'inline-block';
				adDiv.style.display = 'none';
			}
			if(STATE === 'respawn'){
				gameDiv.style.display = 'inline-block';
				signDiv.style.display = 'none';
				disconnectedDiv.style.display = 'none';
				spectatorDiv.style.display = 'none';
				adDiv.style.display = 'inline-block';
			}
			
			if(!selfId){
				return;
			}
			
			
			if(!Player.list[selfId]){
				return;
			}
			//WIDTH = window.innerWidth;
			//HEIGHT = window.innerHeight;
			//ctx.scale(window.innerWidth / 1536,window.innerWidth / 1536);
			if(DEBUG !== 2){
				ctx.fillStyle = maps[Player.list[selfId].map];
			}
			else{
				ctx.fillStyle = "#ffffff";
			}
			ctx.fillRect(0,0,WIDTH,HEIGHT);
			cameraX = WIDTH/2 - Player.list[selfId].x;
			cameraY = HEIGHT/2 - Player.list[selfId].y;
			//mouseCameraX = mouseX / 7;
			//mouseCameraY = mouseY / 7;
			if(lastCameraX - mouseCameraX > 2){
				mouseCameraX = lastCameraX - 2;
			}
			if(lastCameraX - mouseCameraX < -2){
				mouseCameraX = lastCameraX + 2;
			}
			if(lastCameraY - mouseCameraY > 2){
				mouseCameraY = lastCameraY - 2;
			}
			if(lastCameraY - mouseCameraY < -2){
				mouseCameraY = lastCameraY + 2;
			}
			cameraX -= mouseCameraX;
			cameraY -= mouseCameraY;
			if(Player.list[selfId].mapWidth > window.innerWidth){
				if(cameraX > 0){
					cameraX = 0;
				}
				if(cameraX < WIDTH - Player.list[selfId].mapWidth){
					cameraX = WIDTH - Player.list[selfId].mapWidth;
				}
			}
			if(Player.list[selfId].mapHeight > window.innerHeight){
				if(cameraY > 0){
					cameraY = 0;
				}
				if(cameraY < HEIGHT - Player.list[selfId].mapHeight){
					cameraY = HEIGHT - Player.list[selfId].mapHeight;
				}
			}
			lastCameraX = mouseCameraX;
			lastCameraY = mouseCameraY;
			ctx.save();
			ctx.translate(cameraX,cameraY);
			drewMap = false;
			if(mapChange !== 0 && Player.list[selfId].map === lastMap){
				if(mapDirection === 'up'){
					mapSlide += window.innerHeight / 20;
					if(mapSlide > window.innerHeight){
						mapSlide = window.innerHeight;
						mapChange = 1;
					}
					ctx.translate(0,mapSlide);
					if(DEBUG !== 2){
						var i = new Image();
						i.src = '/client/maps/' + currentMap + '0.png';
						ctx.drawImage(i,0,-3200);
						var i = new Image();
						i.src = '/client/maps/' + lastMap + '0.png';
						ctx.drawImage(i,0,0);
					}
				}
				if(mapDirection === 'down'){
					mapSlide -= window.innerHeight / 20;
					if(mapSlide < -window.innerHeight){
						mapSlide = -window.innerHeight;
						mapChange = 1;
					}
					ctx.translate(0,mapSlide);
					if(DEBUG !== 2){
						var i = new Image();
						i.src = '/client/maps/' + currentMap + '0.png';
						ctx.drawImage(i,0,3200);
						var i = new Image();
						i.src = '/client/maps/' + lastMap + '0.png';
						ctx.drawImage(i,0,0);
					}
				}
				if(mapDirection === 'left'){
					mapSlide += window.innerWidth / 20;
					if(mapSlide > window.innerWidth){
						mapSlide = window.innerWidth;
						mapChange = 1;
					}
					ctx.translate(mapSlide,0);
					if(DEBUG !== 2){
						var i = new Image();
						i.src = '/client/maps/' + currentMap + '0.png';
						ctx.drawImage(i,-3200,0);
						var i = new Image();
						i.src = '/client/maps/' + lastMap + '0.png';
						ctx.drawImage(i,0,0);
					}
				}
				if(mapDirection === 'right'){
					mapSlide -= window.innerWidth / 20;
					if(mapSlide < -window.innerWidth){
						mapSlide = -window.innerWidth;
						mapChange = 1;
					}
					ctx.translate(mapSlide,0);
					if(DEBUG !== 2){
						var i = new Image();
						i.src = '/client/maps/' + currentMap + '0.png';
						ctx.drawImage(i,3200,0);
						var i = new Image();
						i.src = '/client/maps/' + lastMap + '0.png';
						ctx.drawImage(i,0,0);
					}
				}
				drewMap = true;
			}
			if(Player.list[selfId].map !== lastMap){
				mapChange = 0;
				mapSlide = 0;
			}
			else if(shadeSpeed === 0){
				mapChange = 2;
			}
			if(DEBUG !== 2 && mapChange === 0){
				var i = new Image();
				i.src = '/client/maps/' + Player.list[selfId].map + '0.png';
				ctx.drawImage(i,0,0);
			}
			for(var i in Player.list){
				Player.list[i].draw();
			}
			for(var i in Projectile.list){
				Projectile.list[i].draw();
			}
			for(var i in Monster.list){
				Monster.list[i].draw();
			}
			
			if(drewMap){
				if(mapDirection === 'up'){
					if(DEBUG !== 2){
						var i = new Image();
						i.src = '/client/maps/' + currentMap + '1.png';
						ctx.drawImage(i,0,-3200);
						var i = new Image();
						i.src = '/client/maps/' + lastMap + '1.png';
						ctx.drawImage(i,0,0);
					}
					if(DEBUG !== 0){
						var i = new Image();
						i.src = '/client/maps/' + currentMap + 'DEBUG.png';
						ctx.drawImage(i,0,-3200);
						var i = new Image();
						i.src = '/client/maps/' + lastMap + 'DEBUG.png';
						ctx.drawImage(i,0,0);
					}
				}
				if(mapDirection === 'down'){
					if(DEBUG !== 2){
						var i = new Image();
						i.src = '/client/maps/' + currentMap + '1.png';
						ctx.drawImage(i,0,3200);
						var i = new Image();
						i.src = '/client/maps/' + lastMap + '1.png';
						ctx.drawImage(i,0,0);
					}
					if(DEBUG !== 0){
						var i = new Image();
						i.src = '/client/maps/' + currentMap + 'DEBUG.png';
						ctx.drawImage(i,0,3200);
						var i = new Image();
						i.src = '/client/maps/' + lastMap + 'DEBUG.png';
						ctx.drawImage(i,0,0);
					}
				}
				if(mapDirection === 'left'){
					if(DEBUG !== 2){
						var i = new Image();
						i.src = '/client/maps/' + currentMap + '1.png';
						ctx.drawImage(i,-3200,0);
						var i = new Image();
						i.src = '/client/maps/' + lastMap + '1.png';
						ctx.drawImage(i,0,0);
					}
					if(DEBUG !== 0){
						var i = new Image();
						i.src = '/client/maps/' + currentMap + 'DEBUG.png';
						ctx.drawImage(i,-3200,0);
						var i = new Image();
						i.src = '/client/maps/' + lastMap + 'DEBUG.png';
						ctx.drawImage(i,0,0);
					}
				}
				if(mapDirection === 'right'){
					if(DEBUG !== 2){
						var i = new Image();
						i.src = '/client/maps/' + currentMap + '1.png';
						ctx.drawImage(i,3200,0);
						var i = new Image();
						i.src = '/client/maps/' + lastMap + '1.png';
						ctx.drawImage(i,0,0);
					}
					if(DEBUG !== 0){
						var i = new Image();
						i.src = '/client/maps/' + currentMap + 'DEBUG.png';
						ctx.drawImage(i,3200,0);
						var i = new Image();
						i.src = '/client/maps/' + lastMap + 'DEBUG.png';
						ctx.drawImage(i,0,0);
					}
				}
			}
			if(DEBUG !== 2 && mapChange === 0){
				var i = new Image();
				i.src = '/client/maps/' + Player.list[selfId].map + '1.png';
				ctx.drawImage(i,0,0);
			}
			if(DEBUG !== 0 && mapChange === 0){
				var i = new Image();
				i.src = '/client/maps/' + Player.list[selfId].map + 'DEBUG.png';
				ctx.drawImage(i,0,0);
			}
			

			for(var i in Monster.list){
				Monster.list[i].drawHp();
			}
			for(var i in Player.list){
				Player.list[i].drawName();
				Player.list[i].drawLight();
			}
			ctx.restore();
			//ctx.scale(1536 / window.innerWidth,1536 / window.innerWidth);

			if(mapShadeAmount >= 2){
				mapShadeSpeed = -0.03;
			}
			if(shadeAmount > 1.6){
				shadeSpeed = -0.08;
			}
			if(shadeAmount < 0.25 && document.getElementById('mapName').innerHTML !== Player.list[selfId].map){
				document.getElementById('mapName').innerHTML = Player.list[selfId].map;
				mapShadeAmount = 0;
				mapShadeSpeed = 0.03;
			}
			shadeAmount += shadeSpeed;
			mapShadeAmount += mapShadeSpeed;
			blackShade.style.opacity = shadeAmount;
			document.getElementById('mapName').style.opacity = mapShadeAmount;
		},25);
		
		function useMenuDropdown() {
			var dropdowns = document.getElementsByClassName("UI-dropdown-light");
			for(var i = 0;i < dropdowns.length;i++){
				var openDropdown = dropdowns[i];
				openDropdown.classList.toggle('dropdownShow');
			}
		}

		window.onclick = function(event){
			if(!event.target.matches('#menuDropdown')){
				var dropdowns = document.getElementsByClassName("UI-dropdown-light");
				for(var i = 0;i < dropdowns.length;i++){
					var openDropdown = dropdowns[i];
					if(openDropdown.classList.contains('dropdownShow')){
						openDropdown.classList.remove('dropdownShow');
					}
				}
			}
			if(!event.target.matches('#chat-input')){
				if(inChat){
					inChat = false;
				}
			}
		}
		document.onkeydown = function(event){
			if(chatPress){
			}
			else{
				if(event.keyCode === 66){
					if(DEBUG === 2){
						DEBUG = 0;
					}
					else{
						DEBUG += 1;
					}
				}
				else if(event.keyCode === 73){
					if(menu === 'none'){
						menu = 'inventory';
						inventoryDiv.style.display = 'inline-block';
					}
					else{
						menu = 'none';
						inventoryDiv.style.display = 'none';
					}
				}
				socket.emit('keyPress',{inputId:event.keyCode,state:true});
			}
		}
		document.onkeyup = function(event){
			chatPress = false;
			socket.emit('keyPress',{inputId:event.keyCode,state:false});
		}
		mouseDown = function(event){
			if(inChat){
				return;
			}
			if(event.button == 0){
				socket.emit('keyPress',{inputId:'attack',state:true});
			}
			if(event.button == 2){
				socket.emit('keyPress',{inputId:'second',state:true});
			}
		}
		mouseUp = function(event){
			if(event.button == 0){
				socket.emit('keyPress',{inputId:'attack',state:false});
			}
			if(event.button == 2){
				socket.emit('keyPress',{inputId:'second',state:false});
			}
		}
		document.onmousemove = function(event){
			if(Player.list[selfId]){
				var x = -1 * cameraX - Player.list[selfId].x + event.clientX;
				var y = -1 * cameraY - Player.list[selfId].y + event.clientY;
				mouseX = event.clientX - WIDTH / 2;
				mouseY = event.clientY - HEIGHT / 2;
				socket.emit('keyPress',{inputId:'direction',state:{x:x,y:y}});
			}
		}
		document.querySelectorAll("button").forEach(function(item){
			item.addEventListener('focus',function(){
				this.blur();
			});
		});
		document.oncontextmenu = function(event){
			event.preventDefault();
		}
	</script>
</body>
</html>