<html>
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width">
	<title>Meadow Guarders</title>
	<link href="client/style.css" rel="stylesheet" type="text/css" >
	<style>
	</style>
</head>
<body>

	<div id="sign" style="display:inline-block;">
		<button id = "signIn" class="UI-button-light">Sign In</button>
		<label id="username-label" class="UI-text-light" for="username">Username:</label>
		<input class="UI-input-light" type="text" id="username" name="username" autocomplete="off"><br><br>
		<label id="password-label" class="UI-text-light" for="password">Password:</label>
		<input class="UI-input-light" type="password" id="password" name="password" autocomplete="off"><br><br>
		<button id ="createAccount" class="UI-button-light">Create Account</button>
		<button id ="deleteAccount" class="UI-button-light">Delete Account</button>
	</div>
	<div id="gameDiv" style="display:none;">
		<canvas id="ctx"></canvas>
		<div id="mainAttack" class="UI-text-light"></div>
		<div id="secondaryAttack" class="UI-text-light"></div>
	</div>
	<div id="ads" style="display:none">
		<button id="ad1" class="UI-button-light" onclick="disconnect()">Get FREE PlastiSnow!</button>
		<button id="ad2" class="UI-button-light" onclick="disconnect()">Do YOU want YOUR ad featured here? Then click <a href="https://forms.gle/stnavsadkja7r7b96">THIS LINK</a> to write a application!</button>
		<button id="ad3" class="UI-button-light" onclick="history.go(0)">InstaPlastiSnow(tm)</button>
	</div>
	<div id="disconnected" style="display:none;">
		<button class="disconnected">Disconnected</button>
	</div>
	<div id="spectator" style="display:none;">
		<button class="spectator">You're a spectator!</button>
		<button class="respawn" onclick="respawn()">Respawn</button>
	</div>
	<script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
	<link href="/client/websiteAssets/MiniSet2.ttf@14d552ae72d147f7b96abae4220f32c0.woff" rel="stylesheet">

	<script src="https://cdn.socket.io/socket.io-1.4.5.js"></script>

	<!--<script src="/client/socket.js"></script>-->
	<script src="/socket.io/socket.io.js"></script>

	<script>
		
		var WIDTH = window.innerWidth;
		var HEIGHT = window.innerHeight;

		var cameraX = 0;
		var cameraY = 0;

		var RENDERDIST = 2;
		var STATE = 'signIn';
		
		var socket = io();

		var gameDiv = document.getElementById('gameDiv');
		var mainAttackDiv = document.getElementById('mainAttack');
		var secondaryAttackDiv = document.getElementById('secondaryAttack');
		var disconnectedDiv = document.getElementById('disconnected');
		var spectatorDiv = document.getElementById('spectator');
		var adDiv = document.getElementById('ads');
		var ctx = document.getElementById('ctx');
		var signDiv = document.getElementById('sign');
		var signDivUsername = document.getElementById('username');
		var signDivPassword = document.getElementById('password');
		var signDivSignIn = document.getElementById('signIn');
		var signDivCreateAccount = document.getElementById('createAccount');
		var signDivDeleteAccount = document.getElementById('deleteAccount');
		

		signDivSignIn.onclick = function(){
			socket.emit('signIn',{username:signDivUsername.value,password:signDivPassword.value});
		}
		signDivCreateAccount.onclick = function(){
			socket.emit('createAccount',{username:signDivUsername.value,password:signDivPassword.value});
		}
		signDivDeleteAccount.onclick = function(){
			socket.emit('deleteAccount',{username:signDivUsername.value});
		}
		socket.on('signInResponse',function(data){
			if(data.success == 2){
				STATE = 'game';
			}
			else if(data.success == 1){
				alert("The account with username \'" + signDivUsername.value + "\' and password \'" + signDivPassword.value + "\' is already used. The other account will be disconnected shortly. Please try to sign again.");
			}
			else{
				alert("No account found with username \'" + signDivUsername.value + "\' and password \'" + signDivPassword.value + "\'.");
			}
		});
		socket.on('createAccountResponse',function(data){
			if(data.success == 1){
				alert("Account created with username \'" + signDivUsername.value + "\' and password \'" + signDivPassword.value + "\'.");
			}
			else if(data.success == 0){
				alert("Sorry, there is already an account with username \'" + signDivUsername.value + "\'.");
			}
			else if(data.success == 2){
				alert("Please use a username with 3+ characters.");
			}
		});
		socket.on('deleteAccountResponse',function(data){
			if(data.success == 1){
				alert("Deleted account created with username \'" + signDivUsername.value + "\'.");
			}
			else if(data.success == 0){
				alert("Sorry, there is no account with username \'" + signDivUsername.value + "\'.");
			}
		});
		
		/*var chatText = document.getElementById('chat-text');
		var chatInput = document.getElementById('chat-input');
		var chatForm = document.getElementById('chat-form');	
		chatText.style.top = window.innerHeight - 135;
		chatForm.style.top = window.innerHeight - 50;
		chatInput.style.top = window.innerHeight - 50;

		socket.on('addToChat',function(data){
			chatText.innerHTML += '<div>' + data + '</div>';
		});
		
		chatForm.onsubmit = function(e){
			e.preventDefault();
			socket.emit('sendMsgToServer',chatInput.value);
			chatInput.value = '';
		}*/

		var disconnect = function(){
			socket.emit("fake");
		}
		var ctx = document.getElementById("ctx").getContext("2d");
		ctx.canvas.width  = window.innerWidth;
		ctx.canvas.height = window.innerHeight;
		
		var Img = {};
		Img.player = new Image();
		Img.player.src = '/client/img/Player.png';
		Img.player2 = new Image();
		Img.player2.src = '/client/img/Base Player.png';
		Img.player3 = new Image();
		Img.player3.src = '/client/img/Base Player Walk 3.png';
		Img.player4 = new Image();
		Img.player4.src = '/client/img/Base Player Walk 4.png';
		Img.ghost = new Image();
		Img.ghost.src = '/client/img/ghost.png';
		Img.bullet = new Image();
		Img.bullet.src = '/client/img/Bullet.png';
		Img.forest = new Image();
		Img.forest.src = '/client/websiteAssets/Forest.png';
		var data;
		var tileset;
		var layers;
		var renderLayer = function(layer){
			if(layer.type !== "tilelayer" || !layer.opacity){
				return;
			}
			var s = ctx.canvas.cloneNode(),
			size = data.tilewidth;
			s = s.getContext("2d");
			if(layers.length < data.layers.length || 1){
				layer.data.forEach(function(tile_idx, i){
					if(!tile_idx){
						return;
					}
					var img_x, img_y, s_x, s_y,
					tile = data.tilesets[0];
					tile_idx -= 1;
					img_x = (tile_idx % ((tile.imagewidth + tile.spacing) / (size + tile.spacing))) * (size + tile.spacing);
					img_y = ~~(tile_idx / ((tile.imagewidth + tile.spacing) / (size + tile.spacing))) * (size + tile.spacing);
					s_x = (i % layer.width) * size;
					s_y = ~~(i / layer.width) * size;
					if(!Player.list[selfId]){
						return;
					}
					if(Player.list[selfId].x - WIDTH < s_x && Player.list[selfId].x + WIDTH > s_x && Player.list[selfId].y - HEIGHT < s_y && Player.list[selfId].y + HEIGHT > s_y){
						ctx.drawImage(tileset,img_x,img_y,size,size,s_x,s_y,size,size);
					}
				});
				//layers.push(s.canvas.toDataURL());
				//ctx.drawImage(s.canvas, 0, 0);
			}
		}
		var renderLayers = function(){
			if(Array.isArray(layers) === false){
				layers = data.layers;
			}
    		layers.forEach(renderLayer);
		}
		var loadTileset = function(json){
			data = json;
			layers = undefined;
			tileset = $("<img />",{Src:json.tilesets[0].image})[0];
			tileset.onload = renderLayers();
		}
		var load = function(name){
			return $.getJSON("/client/maps/" + name + ".json",function(json){
				loadTileset(json);
			});
		}


		var selfId = null;

		var respawn = function(){
			socket.emit('respawn');
			STATE = 'game';
		}

		var Player = function(initPack){
			var self = {};
			self.id = initPack.id;
			self.username = initPack.username;
			self.x = initPack.x;
			self.y = initPack.y;
			self.img = initPack.img;
			self.direction = initPack.direction;
			self.hp = initPack.hp;
			self.hpMax = initPack.hpMax;
			self.map = initPack.map;
			self.attackReload = initPack.attackReload;
			self.secondReload = initPack.secondReload;
			self.mapHeight = 3200;
			self.mapWidth = 3200;
			self.updated = true;
			
			self.draw = function(){
				switch(self.img){
					case 'player':
						ctx.drawImage(Img.player,self.x - 16,self.y - 30);
						break;
					case 'none':
						ctx.drawImage(Img.ghost,self.x - 16,self.y - 30);
						break;
				}
			}
			self.drawName = function(){
				if(self.img === 'none'){
					return;
				}
				ctx.font = "15px pixel";
				ctx.fillStyle = '#ff7700';
				ctx.textAlign = "center";
				ctx.fillText(self.username,self.x - 1,self.y - 80);
				ctx.fillStyle = '#555555';
				ctx.fillRect(self.x - 52,self.y - 70,104,10);
				ctx.fillStyle = '#aa5525';
				ctx.fillRect(self.x - 50,self.y - 68,self.hp / self.hpMax * 100,6);
				if(self.attackReload > 24){
					self.attackReload = 25;
					mainAttackDiv.style.color = "#25ff25";
				}
				else{
					mainAttackDiv.style.color = "#ff2525";
				}
				if(self.secondReload > 249){
					self.secondReload = 250;
					secondaryAttackDiv.style.color = "#25ff25";
				}
				else{
					secondaryAttackDiv.style.color = "#ff2525";
				}
				mainAttackDiv.innerHTML = "Main Attack: " + self.attackReload / 25;
				secondaryAttackDiv.innerHTML = "Secondary Attack: " + self.secondReload / 25;
			}
			Player.list[self.id] = self;
			return self;
		}
		Player.list = {};
		var Projectile = function(initPack){
			var self = {};
			self.id = initPack.id;
			self.x = initPack.x;
			self.y = initPack.y;
			self.direction = initPack.direction;
			self.hp = initPack.hp;
			self.hpMax = initPack.hpMax;
			self.map = initPack.map;
			self.updated = true;
			self.draw = function(){
				ctx.drawImage(Img.bullet,self.x - 24,self.y - 24);
			}
			Projectile.list[self.id] = self;
			return self;
		}
		Projectile.list = {};

		socket.on('selfId',function(data){
			selfId = data;
		});
		socket.on('update',function(data){
			for(var i in Player.list){
				Player.list[i].updated = false;
			}
			for(var i in Projectile.list){
				Projectile.list[i].updated = false;
			}
			if(data){
				for(var i = 0;i < data.player.length;i++){
					if(Player.list[data.player[i].id]){
						if(data.player[i].x){
							Player.list[data.player[i].id].x = data.player[i].x;
						}
						if(data.player[i].y){
							Player.list[data.player[i].id].y = data.player[i].y;
						}
						if(data.player[i].img){
							Player.list[data.player[i].id].img = data.player[i].img;
						}
						if(data.player[i].hp){
							Player.list[data.player[i].id].hp = data.player[i].hp;
						}
						if(data.player[i].map){
							Player.list[data.player[i].id].map = data.player[i].map;
						}
						if(data.player[i].attackReload){
							Player.list[data.player[i].id].attackReload = data.player[i].attackReload;
						}
						if(data.player[i].secondReload){
							Player.list[data.player[i].id].secondReload = data.player[i].secondReload;
						}
						if(data.player[i].mapWidth){
							Player.list[data.player[i].id].mapWidth = data.player[i].mapWidth;
						}
						if(data.player[i].mapHeight){
							Player.list[data.player[i].id].mapHeight = data.player[i].mapHeight;
						}
						Player.list[data.player[i].id].updated = true;
					}
					else{
						new Player(data.player[i]);
					}
				}
				if(data.projectile.length > 0){
					for(var i = 0;i < data.projectile.length;i++){
						if(Projectile.list[data.projectile[i].id]){
							if(data.projectile[i].x){
								Projectile.list[data.projectile[i].id].x = data.projectile[i].x;
							}
							if(data.projectile[i].y){
								Projectile.list[data.projectile[i].id].y = data.projectile[i].y;
							}
							Projectile.list[data.projectile[i].id].updated = true;
						}
						else{
							new Projectile(data.projectile[i]);
						}
					}
				}
			}
			for(var i in Player.list){
				if(Player.list[i].updated === false){
					delete Player.list[i];
				}
			}
			for(var i in Projectile.list){
				if(Projectile.list[i].updated === false){
					delete Projectile.list[i];
				}
			}
		});
		socket.on('disconnected',function(data){
			STATE = 'disconnected';
			setTimeout(function(){
				location.reload();
			},5000);
		});
		socket.on('spectator',function(data){
			STATE = 'spectator';
		});
		socket.on('changeMap',function(data){
			load(data);
		});
		load('river');
		setInterval(function(){
			if(STATE === 'signIn'){
				gameDiv.style.display = 'none';
				signDiv.style.display = 'inline-block';
				disconnectedDiv.style.display = 'none';
				spectatorDiv.style.display = 'none';
				adDiv.style.display = 'none';
			}
			if(STATE === 'disconnected'){
				gameDiv.style.display = 'inline-block';
				signDiv.style.display = 'none';
				disconnectedDiv.style.display = 'inline-block';
				spectatorDiv.style.display = 'none';
				adDiv.style.display = 'none';
			}
			if(STATE === 'spectator'){
				gameDiv.style.display = 'inline-block';
				signDiv.style.display = 'none';
				disconnectedDiv.style.display = 'none';
				spectatorDiv.style.display = 'inline-block';
				adDiv.style.display = 'inline-block';
			}
			if(STATE === 'game'){
				gameDiv.style.display = 'inline-block';
				signDiv.style.display = 'none';
				disconnectedDiv.style.display = 'none';
				spectatorDiv.style.display = 'none';
				adDiv.style.display = 'inline-block';
			}
			
			if(!selfId){
				return;
			}
			WIDTH = window.innerWidth;
			HEIGHT = window.innerHeight;
			ctx.canvas.width = window.innerWidth;
			ctx.canvas.height = window.innerHeight;
			ctx.scale(window.innerWidth / 1536,window.innerWidth / 1536);
			ctx.clearRect(0,0,WIDTH,HEIGHT);
			if(!Player.list[selfId]){
				return;
			}
			cameraX = WIDTH/2 - Player.list[selfId].x;
			cameraY = HEIGHT/2 - Player.list[selfId].y;
			if(Player.list[selfId].x < WIDTH / 2){
				cameraX = 0;
			}
			if(Player.list[selfId].x > Player.list[selfId].mapWidth - WIDTH / 2){
				cameraX = WIDTH - Player.list[selfId].mapWidth;
			}
			if(Player.list[selfId].y < HEIGHT / 2){
				cameraY = 0;
			}
			if(Player.list[selfId].y > Player.list[selfId].mapHeight - HEIGHT / 2){
				cameraY = HEIGHT - Player.list[selfId].mapHeight;
			}
			ctx.translate(cameraX,cameraY);
			renderLayers();
			for(var i in Player.list){
				Player.list[i].draw();
				Player.list[i].drawName();
			}
			for(var i in Projectile.list){
				Projectile.list[i].draw();
			}
			ctx.translate(-cameraX,-cameraY);
			ctx.scale(1536 / window.innerWidth,1536 / window.innerWidth);
			
		},25);
		document.onkeydown = function(event){
			socket.emit('keyPress',{inputId:event.keyCode,state:true});
		}
		document.onkeyup = function(event){
			socket.emit('keyPress',{inputId:event.keyCode,state:false});
		}
		
		document.onmousedown = function(event){
			if(event.button == 0){
				socket.emit('keyPress',{inputId:'attack',state:true});
			}
			if(event.button == 2){
				socket.emit('keyPress',{inputId:'second',state:true});
			}
		}
		document.onmouseup = function(event){
			if(event.button == 0){
				socket.emit('keyPress',{inputId:'attack',state:false});
			}
			if(event.button == 2){
				socket.emit('keyPress',{inputId:'second',state:false});
			}
		}
		document.onmousemove = function(event){
			if(Player.list[selfId]){
				var x = -1 * cameraX - Player.list[selfId].x + event.clientX;
				var y = -1 * cameraY - Player.list[selfId].y + event.clientY;
				socket.emit('keyPress',{inputId:'direction',state:{x:x,y:y}});
			}
		}
		
		document.oncontextmenu = function(event){
			event.preventDefault();
		}
	</script>
</body>
</html>